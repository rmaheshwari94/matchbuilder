<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MatchBuilder – Speed Dating Toolkit</title>
<style>
  :root{--b:#111;--g:#666;--bd:#e6e6e6}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.45;margin:24px;max-width:980px}
  h1{font-size:1.6rem;margin:0 0 12px}
  legend{font-weight:700;padding:0 8px}
  fieldset{border:1px solid var(--bd);border-radius:12px;padding:16px;margin:16px 0;background:#fff}
  .muted{color:var(--g);font-size:.92rem}
  .row{display:grid;gap:12px}
  .row2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .row3{grid-template-columns:repeat(3,minmax(0,1fr))}
  label{display:flex;gap:8px;align-items:center}
  input[type="text"],input[type="number"],select{width:100%;padding:8px;border:1px solid var(--bd);border-radius:10px;background:#fff}
  input[type="range"]{width:100%}
  button{padding:10px 14px;border:1px solid var(--bd);border-radius:10px;background:#fff;cursor:pointer}
  button.primary{background:var(--b);color:#fff;border-color:var(--b)}
  textarea{width:100%;min-height:280px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:.9rem;padding:12px;border:1px solid var(--bd);border-radius:12px;background:#fff}
  .subtle{opacity:.65}
  .list{display:grid;gap:8px}
  .prefRow{display:grid;grid-template-columns:1fr auto;align-items:center;gap:12px}
  .sliderRow{margin:2px 0 14px}
  .hide{display:none}

  /* Flow builder */
  .flow-wrap{border:1px dashed var(--bd);border-radius:12px;padding:10px}
  .flow-list{display:flex;gap:10px;flex-wrap:wrap;min-height:64px}
  .flow-step{border:1px solid var(--bd);border-radius:12px;padding:10px 12px;background:#fafafa;cursor:grab;user-select:none}
  .flow-step.dragging{opacity:.5}
  .flow-step.hide{display:none}
  .flow-presets{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .tag{display:inline-block;padding:2px 8px;border:1px solid var(--bd);border-radius:999px;font-size:.85rem;background:#fff}
</style>
</head>
<body>
<h1>MatchBuilder</h1>
<p class="muted">Generate a Google Apps Script with a simple menu that builds Forms, a Hungarian-style schedule, optional Slides & QR codes, Groups (with optional pre-activity intent), and post-event email.</p>

<form id="f">
<!-- 1) PROJECT -->
<fieldset>
  <legend>Project</legend>
  <div class="row row2">
    <label>Project title
      <input id="title" type="text" placeholder="e.g., NYC Singles – Oct 2025"/>
    </label>
  </div>
  <div class="list" style="margin-top:8px">
    <label class="subtle"><input type="checkbox" checked disabled/> Create a menu with numbered steps</label>
    <label><input id="optForm" type="checkbox" checked/> Create intake form</label>
    <label><input id="optQRCodes" type="checkbox"/> Create QR codes for all forms</label>
    <label><input id="optSchedule" type="checkbox" checked/> Create speed dating schedule</label>
    <label><input id="optSlides" type="checkbox" checked/> Create slides for speed dating schedule</label>
    <label><input id="optGroups" type="checkbox"/> Create groups for activities</label>
    <label><input id="optPostForm" type="checkbox" checked/> Post-event matching form</label>
    <label><input id="optReset" type="checkbox" checked/> Complete reset button</label>
  </div>
</fieldset>

<!-- 2) DRAG & DROP FLOW -->
<fieldset>
  <legend>Build your flow (drag to reorder)</legend>
  <p class="muted">Turn steps on/off above. If <em>Speed Dating</em> comes before <em>Group Activity</em>, we’ll add a mid-event “Group-Activity Intent” form automatically.</p>

  <div class="flow-presets">
    <button type="button" class="tag" data-preset="intake-speed-groups-post">Intake → Speed Dating → Group Activity → Post-Event Matching</button>
    <button type="button" class="tag" data-preset="intake-groups-speed-post">Intake → Group Activity → Speed Dating → Post-Event Matching</button>
    <button type="button" class="tag" data-preset="intake-groups-post">Intake → Group Activity → Post-Event Matching</button>
    <button type="button" class="tag" data-preset="intake-speed-post">Intake → Speed Dating → Post-Event Matching</button>
    <button type="button" class="tag" data-preset="intake-speed-groups">Intake → Speed Dating → Group Activity (no post)</button>
    <button type="button" class="tag" data-preset="intake-groups-speed">Intake → Group Activity → Speed Dating (no post)</button>
  </div>

  <div class="flow-wrap">
    <div id="flowList" class="flow-list" aria-label="Flow">
      <div class="flow-step" draggable="true" data-step="intake" id="step-intake">Intake</div>
      <div class="flow-step" draggable="true" data-step="speed"  id="step-speed">Speed Dating</div>
      <div class="flow-step" draggable="true" data-step="groups" id="step-groups">Group Activity</div>
      <div class="flow-step" draggable="true" data-step="post"   id="step-post">Post-Event Matching</div>
    </div>
  </div>
</fieldset>

<!-- 3) INTAKE INFO -->
<fieldset>
  <legend>Attendee intake information</legend>
  <p class="muted">Name & Gender always collected. Age will be asked in the form (clean dropdown), so we keep this UI simple.</p>
  <div class="list">
    <label class="subtle"><input type="checkbox" checked disabled/> Name</label>
    <label class="subtle"><input type="checkbox" checked disabled/> Gender</label>
    <label class="subtle"><input type="checkbox" checked disabled/> Age</label>
    <label><input id="fldEmail" type="checkbox" checked/> Email</label>
    <label><input id="fldPhone" type="checkbox" checked/> Phone Number</label>
    <label><input id="fldZip" type="checkbox" checked/> Attendee Zip Code — for distance matching</label>
    <label><input id="fldDiet" type="checkbox"/> Dietary restriction (discrete)</label>
  </div>

  <h4 style="margin:12px 0 6px">Additional variables</h4>
  <p class="muted">Add optional fields. “Numeric” uses a 0–10 dropdown (clean for scoring).</p>
  <div class="row row3">
    <input id="addName" type="text" placeholder="e.g., Hobbies"/>
    <select id="addType">
      <option value="nominal">Nominal (single choice)</option>
      <option value="multi">Multi-select (checkboxes)</option>
      <option value="numeric">Numeric (0–10 dropdown)</option>
    </select>
    <button type="button" id="addVar">Add field</button>
  </div>
  <ul id="varList" class="list" style="margin-top:8px"></ul>
</fieldset>

<!-- 4) PREFERENCES -->
<fieldset>
  <legend>Attendee preferences (used for matching)</legend>
  <p class="muted">
    Set importance with sliders. Check “Dealbreaker” to enforce a hard rule.<br>
    <strong>What does Dealbreaker mean?</strong> If either person marks a preference as a dealbreaker and the pair doesn’t satisfy it, they will <em>never</em> be matched. This may reduce the number of possible pairings.
  </p>
  <div id="prefList" class="list"></div>
</fieldset>

<!-- 5) SCHEDULE -->
<fieldset>
  <legend>Speed-dating schedule</legend>
  <div class="row row3">
    <label>Rounds <input id="rounds" type="number" value="8" min="1"/></label>
    <label>Stations <input id="stations" type="number" value="8" min="1"/></label>
    <label id="slidesNameWrap">Google Slides File Name <input id="slidesName" type="text" placeholder="e.g., NYC Singles – Slides"/></label>
  </div>
  <div class="list" style="margin-top:8px">
    <label><input id="keepSeatedMinority" type="checkbox"/> Keep the minority gender seated (other gender rotates)</label>
  </div>
  <p class="muted hide" id="qrNote">QR to the post-event match form will be on the final slide.</p>
</fieldset>

<!-- 6) GROUPS -->
<fieldset id="groupsFs">
  <legend>Groups for activities</legend>
  <p class="muted">Groups are created using intake preferences and, if your flow has Speed Dating before Group Activity, attendees’ pre-activity requests (intent).</p>
  <div class="row row3">
    <label>Group size <input id="grpSize" type="number" value="5" min="2"/></label>
    <label><input id="grpGenderBalance" type="checkbox"/> Balance genders in each group</label>
  </div>
</fieldset>

<!-- 7) POST EVENT -->
<fieldset id="postFs">
  <legend>Post-event matching</legend>
  <div class="row row2">
    <label><input id="sameGenderOK" type="checkbox"/> Allow same-gender matching</label>
    <label>Email behavior
      <select id="emailMode">
        <option value="mutual">Send emails to mutual matches only</option>
        <option value="both">Send mutual + “you were selected” notices</option>
        <option value="none">Do not send emails (export only)</option>
      </select>
    </label>
  </div>
</fieldset>

<div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 14px">
  <button type="button" id="gen" class="primary">Generate Script</button>
  <button type="button" id="copy">Copy</button>
  <button type="button" id="dl">Download .gs</button>
  <button type="button" id="clear">Clear</button>
</div>
<textarea id="out" placeholder="// Apps Script will appear here…"></textarea>
</form>

<script>
/* ---------- helpers ---------- */
const el = id => document.getElementById(id);
const q = (sel,root=document)=>root.querySelector(sel);
const qa = (sel,root=document)=>Array.from(root.querySelectorAll(sel));

/* ---------- dynamic prefs ---------- */
const extraFields = [];   // {label,type}
let prefDefs = [];        // built from intake toggles + extras

function basePrefs(){
  // Gender preference is ALWAYS a hard dealbreaker; no slider.
  const prefs = [
    { key:'genderPref', label:'Gender Preference(s)', type:'special-gender', deal:true, lock:true, w:0 },
    { key:'ageRange',   label:'Age Preference', type:'age', deal:false, lock:false, w:0.7 },
    ...(el('fldZip').checked ? [{ key:'distance', label:'Geographical Distance Matching', type:'distance', dealNote:'each attendee will be asked if this is a dealbreaker', lock:false, w:0.3 }] : [])
  ];
  if (el('fldDiet').checked) prefs.push({ key:'Dietary restriction', label:'Dietary restriction', type:'nominal', deal:false, lock:false, w:0.5 });
  extraFields.forEach(f=> prefs.push({ key:f.label, label:f.label, type:f.type, deal:false, lock:false, w:0.5 }));
  return prefs;
}
function renderPrefs(){
  prefDefs = basePrefs();
  const wrap = el('prefList'); wrap.innerHTML = '';
  prefDefs.forEach(p=>{
    const row = document.createElement('div'); row.className='prefRow';
    const left = document.createElement('div'); left.innerHTML = `<strong>${p.label}</strong>`;
    const right = document.createElement('div');
    if (p.type==='distance'){ right.innerHTML = `<span class="muted">${p.dealNote}</span>`; }
    else if (p.type==='special-gender'){ right.innerHTML = `<span class="muted">Dealbreaker (always on)</span>`; }
    else { right.innerHTML = `<label><input type="checkbox" data-k="${p.key}" data-kind="deal" ${p.lock?'checked disabled':''}/> Dealbreaker</label>`; }
    row.append(left,right); wrap.appendChild(row);

    if (p.type!=='special-gender'){
      const slider = document.createElement('div'); slider.className='sliderRow';
      slider.innerHTML = `<input type="range" min="0" max="100" value="${Math.round((p.w||0)*100)}" data-k="${p.key}" data-kind="weight">
        <div class="muted">Importance: <span data-val="${p.key}">${Math.round((p.w||0)*100)}</span>/100</div>`;
      wrap.appendChild(slider);
    }
  });
}
document.addEventListener('input',(e)=>{
  const kind=e.target.getAttribute('data-kind'); if(!kind) return;
  const key=e.target.getAttribute('data-k'); const p=prefDefs.find(x=>x.key===key); if(!p) return;
  if(kind==='weight'){ p.w=(+e.target.value)/100; const v=document.querySelector(`span[data-val="${key}"]`); if(v) v.textContent=e.target.value; }
  if(kind==='deal'){ p.deal=e.target.checked; }
});
el('addVar').addEventListener('click', ()=>{
  const name=(el('addName').value||'').trim(); if(!name) return;
  const type=el('addType').value; extraFields.push({label:name, type});
  const li=document.createElement('li'); li.textContent = `${name} (${type})`; el('varList').appendChild(li);
  el('addName').value=''; renderPrefs();
});
['fldZip','fldDiet'].forEach(id=> el(id).addEventListener('change', renderPrefs));
el('optSlides').addEventListener('change', ()=> el('slidesNameWrap').classList.toggle('hide', !el('optSlides').checked));
el('optQRCodes').addEventListener('change', ()=> el('qrNote').classList.toggle('hide', !el('optQRCodes').checked));
renderPrefs(); el('slidesNameWrap').classList.toggle('hide', !el('optSlides').checked);

/* ---------- Flow: drag & drop + presets + dynamic visibility ---------- */
const flowList = el('flowList');
let dragged = null;

flowList.addEventListener('dragstart', e=>{
  const step = e.target.closest('.flow-step'); if(!step) return;
  dragged = step; step.classList.add('dragging'); e.dataTransfer.effectAllowed='move';
});
flowList.addEventListener('dragend', e=>{ const s=e.target.closest('.flow-step'); if(s) s.classList.remove('dragging'); dragged=null; });
flowList.addEventListener('dragover', e=>{
  e.preventDefault();
  const after = getDragAfterElement(flowList, e.clientX, e.clientY);
  if (!dragged) return;
  if (after == null){ flowList.appendChild(dragged); }
  else { flowList.insertBefore(dragged, after); }
});
function getDragAfterElement(container, x, y){
  const els = [...container.querySelectorAll('.flow-step:not(.dragging):not(.hide)')];
  let closest = null, closestOffset = Number.NEGATIVE_INFINITY;
  els.forEach(el=>{
    const rect = el.getBoundingClientRect();
    const offset = y - rect.top - rect.height/2;
    if (offset < 0 && offset > closestOffset){ closestOffset = offset; closest = el; }
  });
  return closest;
}

function visibleSteps(){ return qa('.flow-step').filter(s=>!s.classList.contains('hide')).map(s=>s.dataset.step); }
function intentRelevant(){
  const steps = visibleSteps();
  const iSpeed = steps.indexOf('speed');
  const iGroup = steps.indexOf('groups');
  return iSpeed !== -1 && iGroup !== -1 && iSpeed < iGroup;
}

function setStepVisible(stepId, show){
  const elStep = el('step-'+stepId);
  if (!elStep) return;
  elStep.classList.toggle('hide', !show);
  // If re-showing a step that was hidden, append to end for simplicity
  if (show && !flowList.contains(elStep)) flowList.appendChild(elStep);
}

function syncFlowVisibilityFromOptions(){
  setStepVisible('speed',  el('optSchedule').checked);
  setStepVisible('groups', el('optGroups').checked);
  setStepVisible('post',   el('optPostForm').checked);
  // Show/hide fieldsets too
  el('groupsFs').classList.toggle('hide', !el('optGroups').checked);
  el('postFs').classList.toggle('hide', !el('optPostForm').checked);
  // QR note depends on both Slides + Post
  el('qrNote').classList.toggle('hide', !(el('optSlides').checked && el('optPostForm').checked));
}
['optSchedule','optGroups','optPostForm'].forEach(id=> el(id).addEventListener('change', syncFlowVisibilityFromOptions));
syncFlowVisibilityFromOptions();

/* Presets */
const PRESETS = {
  'intake-speed-groups-post': ['intake','speed','groups','post'],
  'intake-groups-speed-post': ['intake','groups','speed','post'],
  'intake-groups-post':       ['intake','groups','post'],
  'intake-speed-post':        ['intake','speed','post'],
  'intake-speed-groups':      ['intake','speed','groups'],          // no post
  'intake-groups-speed':      ['intake','groups','speed']           // no post
};
qa('[data-preset]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const key = btn.getAttribute('data-preset');
    const order = PRESETS[key] || [];
    // Toggle options based on presence
    el('optSchedule').checked = order.includes('speed');
    el('optGroups').checked   = order.includes('groups');
    el('optPostForm').checked = order.includes('post');
    syncFlowVisibilityFromOptions();
    // Reorder visible cards to match preset
    order.forEach(step=>{
      const node = el('step-'+step);
      if (node && !node.classList.contains('hide')) flowList.appendChild(node);
    });
  });
});

/* ---------- Build config ---------- */
function getFlowOrder(){ return visibleSteps(); }
function cfg(){
  return {
    title: el('title').value || 'Speed Dating Event',
    flowOrder: getFlowOrder(),  // array like ['intake','speed','groups','post']
    options:{
      makeMenu:true,
      makeForm: el('optForm').checked,
      makeQRCodes: el('optQRCodes').checked,
      makeSchedule: el('optSchedule').checked,
      makeSlides: el('optSlides').checked,
      makeGroups: el('optGroups').checked,
      makePostForm: el('optPostForm').checked,
      makeReset: el('optReset').checked
    },
    speedDating:{ keepMinoritySeated: el('keepSeatedMinority').checked },
    intake:{
      base:['Name','Gender','Age'],
      email: el('fldEmail').checked,
      phone: el('fldPhone').checked,
      zip:   el('fldZip').checked,
      diet:  el('fldDiet').checked,
      extra: extraFields
    },
    prefs: prefDefs.map(p=>({
      key:p.key, type:p.type, on:true,
      deal:(p.type==='special-gender') ? true : (p.lock?true:!!p.deal),
      weight: (p.type==='special-gender') ? 0 : +((p.w||0).toFixed(3)),
      note:p.dealNote||null
    })),
    schedule:{
      rounds:+el('rounds').value||8,
      stations:+el('stations').value||8,
      slidesName: el('optSlides').checked ? (el('slidesName').value||'Speed Dating Slides') : '',
      qrOnSlides: el('optQRCodes').checked
    },
    groups:{
      size:+el('grpSize').value||5,
      genderBalance: el('grpGenderBalance').checked,
      intent:{ collect: intentRelevant(), maxChoices: 3 } // auto: only if speed precedes groups
    },
    post:{ sameGender: el('sameGenderOK').checked, emailMode: el('emailMode').value }
  };
}

/* ---------- Generate Apps Script (full) ---------- */
function genGAS(){
  const C = cfg();
  const cfgJSON = JSON.stringify(C,null,2);
  return `
/**
 * Generated by MatchBuilder
 * Paste into a bound Apps Script (Extensions → Apps Script). Use the menu.
 * Slim sheets: no Settings tab. Response sheets appear only when forms are linked.
 */
const CONFIG = ${cfgJSON};

/** Menu **/
function onOpen(){
  const ui = SpreadsheetApp.getUi();
  const m = ui.createMenu('Match Setup – Start Here');
  if (CONFIG.options.makeForm)    m.addItem('1) Make the Sign-Up Form', 'step1_makeSignupForm');
  if (CONFIG.options.makeSchedule)m.addItem('2) Build the Speed-Dating Schedule', 'step2_buildSchedule');
  if (CONFIG.options.makeSlides)  m.addItem('3) Create the Slideshow', 'step3_createSlides');
  if (CONFIG.options.makeGroups && CONFIG.groups?.intent?.collect) m.addItem('4) Make Group-Activity Intent Form', 'step4_makeGroupIntentForm');
  if (CONFIG.options.makeGroups)  m.addItem('5) Create Activity Groups', 'step5_createGroups');
  if (CONFIG.options.makePostForm)m.addItem('6) Make the Post-Event Match Form', 'step6_makePostForm');
  if (CONFIG.options.makePostForm)m.addItem('7) Send Results Emails', 'step7_sendResultsEmails');
  if (CONFIG.options.makeReset)   m.addItem('Reset generated sheets (danger)', 'stepX_resetGenerated');
  m.addToUi();
}

/** STEP 1: Sign-Up Form (aggressive validation; age 18–50; numeric fields as dropdown) **/
function step1_makeSignupForm(){
  const ss = SpreadsheetApp.getActive();
  const title = CONFIG.title + ' – Intake';
  const form = FormApp.create(title).setAllowResponseEdits(false);
  form.setCollectEmail(true);

  const name = form.addTextItem().setTitle('Name').setRequired(true);
  name.setValidation(FormApp.createTextValidation().requireTextLengthGreaterThan(1).build());

  form.addListItem().setTitle('Gender')
    .setChoiceValues(['Woman','Man','Nonbinary','Other']).setRequired(true);

  const ages = Array.from({length:33},(_,i)=>String(18+i)); // 18..50
  form.addListItem().setTitle('Age').setChoiceValues(ages).setRequired(true);

  if (CONFIG.intake.phone){
    const p = form.addTextItem().setTitle('Phone Number').setRequired(true);
    p.setValidation(FormApp.createTextValidation()
      .requireTextMatchesPattern('^(\\+1\\s?)?(\\(?\\d{3}\\)?[\\s.-]?)\\d{3}[\\s.-]?\\d{4}$')
      .setHelpText('Enter a valid US phone number')
      .build());
  }
  if (CONFIG.intake.zip){
    const z = form.addTextItem().setTitle('Zip').setRequired(true);
    z.setValidation(FormApp.createTextValidation()
      .requireTextMatchesPattern('^\\d{5}(-\\d{4})?$')
      .setHelpText('Enter 5 digits or 5-4 ZIP')
      .build());
  }
  if (CONFIG.intake.diet){
    form.addListItem().setTitle('Dietary restriction')
      .setChoiceValues(['None','Vegetarian','Vegan','Kosher','Halal','Other']).setRequired(true);
  }
  CONFIG.intake.extra.forEach(f=>{
    if (f.type==='nominal'){
      form.addListItem().setTitle(f.label).setChoiceValues(['Option 1','Option 2','Option 3']).setRequired(true);
    } else if (f.type==='multi'){
      const it = form.addCheckboxItem().setTitle(f.label).setChoiceValues(['Option A','Option B','Option C']).setRequired(true);
      it.setValidation(FormApp.createCheckboxValidation().requireSelectAtLeast(1).build());
    } else {
      form.addListItem().setTitle(f.label+' (number)').setChoiceValues(['0','1','2','3','4','5','6','7','8','9','10']).setRequired(true);
    }
  });

  // Preferences mirrored into form
  if (_prefOn('genderPref')){
    form.addCheckboxItem().setTitle('Preferred Gender(s)').setChoiceValues(['Woman','Man','Nonbinary']).setRequired(true);
  }
  if (_prefOn('ageRange')){
    form.addListItem().setTitle('Preferred Minimum Age (18–50)').setChoiceValues(ages).setRequired(true);
    form.addListItem().setTitle('Preferred Maximum Age (18–50)').setChoiceValues(ages).setRequired(true);
    form.addMultipleChoiceItem().setTitle('Age is a dealbreaker?').setChoiceValues(['Yes','No']).setRequired(true);
  }
  if (_prefOn('distance')){
    form.addMultipleChoiceItem().setTitle('OK meeting outside geographic area?').setChoiceValues(['Yes','No']).setRequired(true);
    form.addMultipleChoiceItem().setTitle('Is distance a dealbreaker?').setChoiceValues(['Yes','No']).setRequired(true);
  }
  CONFIG.prefs.filter(p=>!['genderPref','ageRange','distance','Dietary restriction'].includes(p.key)).forEach(p=>{
    if (p.type==='nominal'){
      form.addListItem().setTitle(p.key + ' (preference)').setChoiceValues(['Option 1','Option 2','Option 3']).setRequired(true);
    } else if (p.type==='multi'){
      const it = form.addCheckboxItem().setTitle(p.key + ' (preferred options)').setChoiceValues(['Option A','Option B','Option C']).setRequired(true);
      it.setValidation(FormApp.createCheckboxValidation().requireSelectAtLeast(1).build());
    } else {
      form.addListItem().setTitle(p.key + ' (preferred number)').setChoiceValues(['0','1','2','3','4','5','6','7','8','9','10']).setRequired(true);
    }
  });

  _writeQR('Intake Form', form.getEditUrl(), form.getPublishedUrl());

  // Link responses into this spreadsheet; rename and protect header
  const intakeResp = _linkFormToThisSpreadsheet(form, 'Intake Responses');
  if (intakeResp) _protectHeaderAuto(intakeResp);
  SpreadsheetApp.getUi().alert('Sign-Up Form created and linked:\\n' + form.getPublishedUrl());
}

/** STEP 2: Schedule (Hungarian round-by-round; seated minority note) **/
function step2_buildSchedule(){
  const ss = SpreadsheetApp.getActive();
  const resp = ss.getSheetByName('Intake Responses');
  if (!resp) throw new Error('Run Sign-Up Form first (Step 1).');
  const sched = ss.getSheetByName('Schedule') || ss.insertSheet('Schedule');

  const data = _read(resp);
  const rows = _dedupeByEmail(data);

  // Decide seated gender if requested
  const counts = rows.reduce((m,r)=>{ const g=(r['Gender']||'').toLowerCase(); m[g]=(m[g]||0)+1; return m; },{});
  let seatedGender = null;
  if (CONFIG.speedDating?.keepMinoritySeated){
    const w = counts['woman']||0, m_ = counts['man']||0;
    seatedGender = (w===m_) ? 'woman' : ((w<m_) ? 'woman':'man');
  }

  // Partition: default hetero if genderPref off, else split roughly
  const defaultHetero = !_prefOn('genderPref');
  const A=[], B=[];
  rows.forEach(r=>{
    const g=(r['Gender']||'').toLowerCase();
    if (defaultHetero){
      if (g==='woman') A.push(r); else if (g==='man') B.push(r);
    } else {
      ((A.length<=B.length)?A:B).push(r);
    }
  });

  const rounds = CONFIG.schedule.rounds|0, stations = CONFIG.schedule.stations|0;
  const seen = new Set();
  const out = [['Round','Station','Person A','Person B']];
  if (seatedGender) out.push(['NOTE','','Seated gender: ' + (seatedGender==='woman'?'Women':'Men'),'']);

  for (let r=1;r<=rounds;r++){
    const {pairs} = _maxWeightedMatchingRound(A,B,seen,rows,defaultHetero);
    for (let s=1; s<=stations; s++){
      const p = pairs[s-1];
      if (!p) { out.push([r,s,'(idle)','(idle)']); continue; }
      out.push([r,s, _nameEmail(p.a), _nameEmail(p.b) ]);
      seen.add(_pairKey(p.a['Email Address'], p.b['Email Address']));
    }
  }

  sched.clear();
  sched.getRange(1,1,out.length,4).setValues(out);
  sched.getRange(1,1,1,4).setFontWeight('bold');
  _protectHeader(sched,4);
  SpreadsheetApp.getUi().alert('Schedule generated.');
}

/** STEP 3: Slides (optional, adds post-form QR on final slide if enabled) **/
function step3_createSlides(){
  if (!CONFIG.options.makeSlides){ SpreadsheetApp.getUi().alert('Slides disabled in Project.'); return; }
  const name = CONFIG.schedule.slidesName || 'Speed Dating Slides';
  const pres = SlidesApp.create(name);
  pres.getSlides()[0].getShapes()[0].getText().setText(CONFIG.title);
  if (CONFIG.options.makeQRCodes && CONFIG.options.makePostForm){
    const postUrl = _ensurePostFormUrl();
    if (postUrl){
      const slide = pres.appendSlide(SlidesApp.PredefinedLayout.BLANK);
      slide.insertTextBox('Scan to submit your matches').setLeft(50).setTop(40);
      const blob = UrlFetchApp.fetch(_qr(postUrl, 400)).getBlob();
      slide.insertImage(blob).setLeft(50).setTop(100).setWidth(300);
    }
  }
  SpreadsheetApp.getUi().alert('Slideshow created: ' + pres.getUrl());
}

/** STEP 4: Group-Activity Intent Form (created only when Speed → Groups) **/
function step4_makeGroupIntentForm(){
  const ss = SpreadsheetApp.getActive();
  const intake = ss.getSheetByName('Intake Responses');
  if (!intake){ SpreadsheetApp.getUi().alert('Run Sign-Up Form first so we can pull names.'); return; }
  if (!CONFIG.groups?.intent?.collect){ SpreadsheetApp.getUi().alert('According to your flow, Group Activity does not follow Speed Dating. No intent form needed.'); return; }

  const rows = _dedupeByEmail(_read(intake));
  const names = rows.map(r => (r['Name'] ? \`\${r['Name']} <\${r['Email Address']||''}>\` : (r['Email Address']||''))).filter(Boolean);

  const maxN = 3; // fixed (no UI)
  const form = FormApp.create((CONFIG.title||'Event') + ' – Group Activity Intent');
  form.setCollectEmail(true);
  form.addSectionHeaderItem().setTitle('Who would you like to have in your group activity?');
  const item = form.addCheckboxItem()
    .setTitle('Select up to ' + maxN + ' people you hope to see in your group')
    .setChoiceValues(names)
    .setRequired(false);
  item.setValidation(FormApp.createCheckboxValidation().requireSelectAtMost(maxN).build());

  _writeQR('Group Activity Intent Form', form.getEditUrl(), form.getPublishedUrl());
  const respSheet = _linkFormToThisSpreadsheet(form, 'Group Intent Responses');
  if (respSheet) _protectHeaderAuto(respSheet);
  SpreadsheetApp.getUi().alert('Group-Activity Intent form created:\\n' + form.getPublishedUrl());
}

/** STEP 5: Groups (uses intent softly if available + optional gender balance) **/
function step5_createGroups(){
  const ss = SpreadsheetApp.getActive();
  const groupsSh = ss.getSheetByName('Groups') || ss.insertSheet('Groups');
  groupsSh.clear();
  groupsSh.getRange(1,1,1,3).setValues([['Group','Member','Notes']]).setFontWeight('bold'); _protectHeader(groupsSh,3);

  const intake = ss.getSheetByName('Intake Responses'); if(!intake) throw new Error('Need Intake Responses.');
  const roster = _dedupeByEmail(_read(intake));
  const intentSh = CONFIG.groups?.intent?.collect ? ss.getSheetByName('Group Intent Responses') : null;
  const intent = intentSh ? _likesGraphFromIntent(intentSh) : {};

  const size = Math.max(2, CONFIG.groups?.size || 5);
  const G = Math.ceil(roster.length / size);
  const buckets = Array.from({length:G},()=>({members:[], women:0, men:0}));
  const wantBalance = !!CONFIG.groups?.genderBalance;

  const stats = roster.map(p=>{
    const e = _normEmail(p['Email Address']||'');
    const pulls = Object.values(intent).filter(set=>set.has(e)).length + (intent[e]?.size||0);
    return {p, pulls};
  }).sort((a,b)=>b.pulls - a.pulls);

  function canPlace(bucket, person){
    if (bucket.members.length >= size) return false;
    if (!wantBalance) return true;
    const g = (person['Gender']||'').toLowerCase();
    const nextWomen = bucket.women + (g==='woman'?1:0);
    const nextMen   = bucket.men   + (g==='man'?1:0);
    return Math.abs(nextWomen - nextMen) <= Math.ceil(size/2);
  }
  function bucketScore(bucket, person){
    const e = _normEmail(person['Email Address']||'');
    const set = intent[e] || new Set();
    let s = 0;
    bucket.members.forEach(m=>{
      const em = _normEmail(m['Email Address']||'');
      if (set.has(em)) s += 2;
      if (intent[em] && intent[em].has(e)) s += 1;
    });
    return s;
  }

  stats.forEach(({p})=>{
    let best=-1, bestScore=-1;
    for (let i=0;i<G;i++){
      const b=buckets[i];
      if (!canPlace(b,p)) continue;
      const s=bucketScore(b,p);
      if (s>bestScore){ best=i; bestScore=s; }
    }
    if (best===-1){ for (let i=0;i<G;i++){ if (buckets[i].members.length<size){ best=i; break; } } }
    const b=buckets[best]; b.members.push(p);
    const g=(p['Gender']||'').toLowerCase(); if(g==='woman') b.women++; if(g==='man') b.men++;
  });

  let row=2;
  buckets.forEach((b,i)=> b.members.forEach(m=>{
    groupsSh.getRange(row,1,1,3).setValues([[i+1, m['Name'] ? \`\${m['Name']} <\${m['Email Address']||''}>\` : (m['Email Address']||''), '']]);
    row++;
  }));
  SpreadsheetApp.getUi().alert('Groups created' + (intentSh ? ' (using pre-activity intent).' : '.') + (wantBalance?' Gender balance aimed.':''));
}

/** STEP 6: Post-Event Form **/
function step6_makePostForm(){
  const ss = SpreadsheetApp.getActive();
  const form = FormApp.create(CONFIG.title + ' – Post-Event Match');
  form.setCollectEmail(true);
  form.addSectionHeaderItem().setTitle('Who did you want to match with?');
  const p = form.addParagraphTextItem().setTitle('Enter emails of people you liked (comma-separated)').setRequired(true);
  p.setValidation(FormApp.createParagraphTextValidation()
    .requireTextMatchesPattern('^\\s*([A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}\\s*(,\\s*[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}\\s*)*)$')
    .setHelpText('Example: a@b.com, c@d.org').build());
  _writeQR('Post-Event Form', form.getEditUrl(), form.getPublishedUrl());
  const postResp = _linkFormToThisSpreadsheet(form, 'Post Match Responses');
  if (postResp) _protectHeaderAuto(postResp);
  SpreadsheetApp.getUi().alert('Post-Event Form created and linked:\\n' + form.getPublishedUrl());
}

/** STEP 7: Email preview/send (mutuals + optional one-way) **/
function step7_sendResultsEmails(){
  const ui = SpreadsheetApp.getUi();
  const choice = ui.prompt('Send Results Emails','Type PREVIEW to preview only, or SEND to actually email.', ui.ButtonSet.OK_CANCEL);
  if (choice.getSelectedButton() !== ui.Button.OK) return;
  const doSend = (choice.getResponseText()||'').trim().toUpperCase() === 'SEND';

  const ss = SpreadsheetApp.getActive();
  const post = ss.getSheetByName('Post Match Responses');
  if (!post) { ui.alert('Could not find "Post Match Responses". Run Step 6 first.'); return; }

  const intakeMap = _loadIntakeMap();
  const graph = _likesGraphFromPostSheet(post);
  const { mutualPairs, oneWay } = _computeMatches(graph, intakeMap);

  const counts = \`Mutual pairs: \${mutualPairs.length}\\nOne-way likes: \${oneWay.length}\`;
  if (!doSend) { ui.alert('PREVIEW\\n'+counts); return; }

  const title = CONFIG.title || 'Your Event';
  let sent = 0, skipped = 0;
  mutualPairs.forEach(([a,b])=>{
    const subj = 'You matched! ('+title+')';
    try { MailApp.sendEmail({to:a, subject:subj, htmlBody:_emailTplMutual(a,b,title), name:title}); sent++; } catch(e){ skipped++; }
    try { MailApp.sendEmail({to:b, subject:subj, htmlBody:_emailTplMutual(b,a,title), name:title}); sent++; } catch(e){ skipped++; }
  });
  if (CONFIG.post.emailMode === 'both'){
    oneWay.forEach(({from,to})=>{
      try { MailApp.sendEmail({to, subject:'Someone wanted to match with you ('+title+')', htmlBody:_emailTplOneWay(to, from, title), name:title}); sent++; } catch(e){ skipped++; }
    });
  }
  ui.alert(\`Done.\\n\${counts}\\nEmails sent: \${sent}\\nSkipped: \${skipped}\`);
}

/** Reset (keeps response sheets & Slides) **/
function stepX_resetGenerated(){
  const ss = SpreadsheetApp.getActive();
  ['Schedule','Groups','QR Codes'].forEach(n=>{ const sh=ss.getSheetByName(n); if(sh) sh.clear(); });
  SpreadsheetApp.getUi().alert('Cleared generated sheets. (Forms and their response sheets remain.)');
}

/* ===== Helpers ===== */
function _sheet(ss,name){ return ss.getSheetByName(name)||ss.insertSheet(name); }
function _protectHeader(sh, cols){
  const r = sh.getRange(1,1,1,cols);
  const p = r.protect().setDescription(sh.getName()+' header');
  p.removeEditors(p.getEditors());
  p.addEditor(Session.getEffectiveUser());
}
function _protectHeaderAuto(sh){
  const cols = Math.max(1, sh.getLastColumn());
  _protectHeader(sh, cols);
}
function _qr(u, size){ return 'https://chart.googleapis.com/chart?chs='+size+'x'+size+'&cht=qr&chl='+encodeURIComponent(u); }
function _writeQR(label, editUrl, liveUrl){
  const ss = SpreadsheetApp.getActive(), sh = _sheet(ss,'QR Codes');
  const row = sh.getLastRow()+1;
  sh.getRange(row,1,1,2).setValues([[label, liveUrl]]);
  try{ if (CONFIG.options.makeQRCodes){ const blob=UrlFetchApp.fetch(_qr(liveUrl, 300)).getBlob(); sh.insertImage(blob,3,row);} }catch(e){}
}
function _linkFormToThisSpreadsheet(form, desiredName){
  const ss = SpreadsheetApp.getActive();
  const before = ss.getSheets().map(s=>s.getSheetId());
  form.setDestination(FormApp.DestinationType.SPREADSHEET, ss.getId());
  SpreadsheetApp.flush();
  const after = ss.getSheets();
  const added = after.find(s => before.indexOf(s.getSheetId()) === -1);
  if (added) { try{added.setName(desiredName);}catch(e){} return added; }
  return ss.getSheetByName(desiredName) || ss.getSheetByName('Form Responses 1');
}
function _read(sh){ const v=sh.getDataRange().getDisplayValues(); const h=v.shift(); return v.filter(r=>r.join('').trim()!=='').map(r=>{const o={}; h.forEach((c,i)=>o[c]=r[i]); return o;}); }
function _normEmail(x){ return String(x||'').trim().toLowerCase(); }
function _nameEmail(r){ const e=r['Email Address']||''; return r['Name'] ? r['Name']+' <'+e+'>' : e; }
function _pairKey(a,b){ const A=_normEmail(a),B=_normEmail(b); return [A,B].sort().join('|'); }
function _zip5(z){ const m=String(z||'').match(/\\d{5}/); return m?m[0]:''; }
function _dedupeByEmail(rows){
  const idx={}; const out=[];
  rows.forEach(r=>{
    const em=_normEmail(r['Email Address']); if(!em) return;
    const t = new Date(r['Timestamp']).getTime()||0;
    if(!(em in idx)){ idx[em]=out.length; out.push(r); }
    else {
      const prev = out[idx[em]];
      const tp = new Date(prev['Timestamp']).getTime()||0;
      if (t>=tp) out[idx[em]] = r;
    }
  });
  return out;
}

/** Maps distance from ZIPs (Apps Script Maps service) */
function geocodeZip(zip){
  try{ const res = Maps.newGeocoder().geocode(zip); if(res.status==='OK' && res.results && res.results[0]){ const loc=res.results[0].geometry.location; return {lat:loc.lat, lng:loc.lng}; } }catch(e){}
  return null;
}
function distanceMilesFromZips(zipA, zipB){
  const a = geocodeZip(_zip5(zipA)), b = geocodeZip(_zip5(zipB));
  if(!a||!b) return null;
  return _hav(a.lat,a.lng,b.lat,b.lng);
}
function _hav(lat1,lon1,lat2,lon2){
  const R=3958.761; const toRad=x=>x*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const s = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(s));
}

/** Pref helpers */
function _prefOn(key){ const p=CONFIG.prefs.find(x=>x.key===key); return !!(p && p.on!==false); }
function _pref(key){ return CONFIG.prefs.find(x=>x.key===key); }

/** Scoring (0..1) with dealbreakers */
function _score(a,b, defaultHetero){
  const gA=(a['Gender']||'').toLowerCase(), gB=(b['Gender']||'').toLowerCase();

  // Gender (hard dealbreaker if enabled)
  if (!_prefOn('genderPref')){
    const hetero = (gA==='woman' && gB==='man') || (gA==='man' && gB==='woman');
    if (!hetero) return 0;
  } else {
    const pa=(a['Preferred Gender(s)']||'').toLowerCase(), pb=(b['Preferred Gender(s)']||'').toLowerCase();
    const aOk = pa.includes(gB), bOk = pb.includes(gA);
    if (!aOk || !bOk) return 0; // mandatory dealbreaker
  }

  let score = 0;

  // Age
  if (_prefOn('ageRange')){
    const p=_pref('ageRange');
    const aAge=+a['Age']||0, bAge=+b['Age']||0;
    const aMin=+a['Preferred Minimum Age']||18, aMax=+a['Preferred Maximum Age']||50;
    const bMin=+b['Preferred Minimum Age']||18, bMax=+b['Preferred Maximum Age']||50;
    const aPass=(bAge>=aMin && bAge<=aMax), bPass=(aAge>=bMin && aAge<=bMax);
    if (p.deal && (!aPass||!bPass)) return 0;
    const w=p.weight||0; if (w>0){ score += w*((aPass?0.5:0)+(bPass?0.5:0)); }
  }

  // Distance
  if (_prefOn('distance')){
    const p=_pref('distance');
    const zA=a['Zip']||'', zB=b['Zip']||'';
    const miles=(zA&&zB)?distanceMilesFromZips(zA,zB):null;
    const okOutsideA=(a['OK meeting outside geographic area?']||'No')==='Yes';
    const okOutsideB=(b['OK meeting outside geographic area?']||'No')==='Yes';
    const distDealA=(a['Is distance a dealbreaker?']||'No')==='Yes';
    const distDealB=(b['Is distance a dealbreaker?']||'No')==='Yes';
    const within = miles===null ? true : miles<=25; // tweak threshold if needed
    if ((distDealA||distDealB) && !within) return 0;
    const w=p.weight||0; if (w>0){ score += w*(within ? 1 : (okOutsideA && okOutsideB ? 0.6 : 0.2)); }
  }

  // Diet
  if (_prefOn('Dietary restriction')){
    const p=_pref('Dietary restriction');
    const eq=(a['Dietary restriction']||'')===(b['Dietary restriction']||'');
    if (p.deal && !eq) return 0;
    const w=p.weight||0; if (w>0) score += w*(eq?1:0);
  }

  // Custom extras
  CONFIG.prefs.filter(p=>!['genderPref','ageRange','distance','Dietary restriction'].includes(p.key)).forEach(p=>{
    const w=p.weight||0; if (w<=0) return;
    if (p.type==='nominal'){
      const eq=(a[p.key]||'')===(b[p.key]||'');
      if (p.deal && !eq) { score = 0; return; }
      score += w*(eq?1:0);
    } else if (p.type==='multi'){
      const setA=new Set(String(a[p.key+' (preferred options)']||'').split(',').map(x=>x.trim()).filter(Boolean));
      const setB=new Set(String(b[p.key+' (preferred options)']||'').split(',').map(x=>x.trim()).filter(Boolean));
      const inter=[...setA].filter(x=>setB.has(x)).length;
      const uni=new Set([...setA,...setB]).size||1;
      const sim=inter/uni;
      if (p.deal && sim===0){ score = 0; return; }
      score += w*sim;
    } else {
      const av=+(a[p.key+' (preferred number)']||0), bv=+(b[p.key+' (preferred number)']||0);
      const sim = 1 - Math.min(1, Math.abs(av-bv)/10);
      if (p.deal && sim<0.5){ score = 0; return; }
      score += w*sim;
    }
  });

  return score;
}

/** Build one round with Hungarian and avoid repeats */
function _maxWeightedMatchingRound(A,B,seen,allRows, defaultHetero){
  const n = Math.max(A.length,B.length);
  const INF=1e6;
  const cost = Array.from({length:n},()=>Array(n).fill(INF));
  const idxA=[], idxB=[];
  for(let i=0;i<n;i++){ idxA[i]=A[i]||null; idxB[i]=B[i]||null; }
  for(let i=0;i<n;i++){
    for(let j=0;j<n;j++){
      const a=idxA[i], b=idxB[j];
      if(!a||!b){ cost[i][j]=INF; continue; }
      const k=_pairKey(a['Email Address'], b['Email Address']);
      if (seen.has(k)){ cost[i][j]=INF; continue; }
      const s=_score(a,b, defaultHetero);
      if (s<=0){ cost[i][j]=INF; continue; }
      cost[i][j]=1-s; // minimize
    }
  }
  const assign=_hungarian(cost);
  const pairs=[];
  assign.forEach((j,i)=>{ if(j>=0 && idxA[i] && idxB[j] && cost[i][j]<INF) pairs.push({a:idxA[i], b:idxB[j]}); });
  return {pairs};
}

/** Hungarian algorithm (square matrix) -> array colIndex per row (or -1). */
function _hungarian(a){
  const n=a.length; if(!n) return [];
  const m=a.map(r=>r.slice());
  for(let i=0;i<n;i++){ let min=Math.min.apply(null,m[i]); for(let j=0;j<n;j++) m[i][j]-=min; }
  for(let j=0;j<n;j++){ let min=Infinity; for(let i=0;i<n;i++) if(m[i][j]<min) min=m[i][j]; for(let i=0;i<n;i++) m[i][j]-=min; }

  const star=Array.from({length:n},()=>Array(n).fill(false));
  const prime=Array.from({length:n},()=>Array(n).fill(false));
  const coverRow=Array(n).fill(false), coverCol=Array(n).fill(false);

  for(let i=0;i<n;i++){
    for(let j=0;j<n;j++){
      if(m[i][j]===0 && !coverRow[i] && !coverCol[j]){ star[i][j]=true; coverRow[i]=coverCol[j]=true; }
    }
  }
  coverRow.fill(false); coverCol.fill(false);

  function findZero(){
    for(let i=0;i<n;i++) if(!coverRow[i])
      for(let j=0;j<n;j++) if(!coverCol[j] && m[i][j]===0) return [i,j];
    return null;
  }
  function findStarInRow(r){ for(let j=0;j<n;j++) if(star[r][j]) return j; return -1; }
  function findStarInCol(c){ for(let i=0;i<n;i++) if(star[i][c]) return i; return -1; }
  function findPrimeInRow(r){ for(let j=0;j<n;j++) if(prime[r][j]) return j; return -1; }
  function minUncovered(){ let min=Infinity; for(let i=0;i<n;i++) if(!coverRow[i]) for(let j=0;j<n;j++) if(!coverCol[j] && m[i][j]<min) min=m[i][j]; return min; }

  while(true){
    coverCol.fill(false);
    for(let i=0;i<n;i++) for(let j=0;j<n;j++) if(star[i][j]) coverCol[j]=true;
    if (coverCol.filter(Boolean).length===n) break;

    let z;
    while((z=findZero())===null){
      const min=minUncovered();
      for(let i=0;i<n;i++) if(coverRow[i]) for(let j=0;j<n;j++) m[i][j]+=min;
      for(let j=0;j<n;j++) if(!coverCol[j]) for(let i=0;i<n;i++) m[i][j]-=min;
    }
    let [r,c]=z; prime[r][c]=true;
    const sc=findStarInRow(r);
    if (sc!==-1){
      coverRow[r]=true; coverCol[sc]=false;
    }else{
      const path=[[r,c]];
      while(true){
        const r2=findStarInCol(path[path.length-1][1]);
        if (r2===-1) break;
        path.push([r2, path[path.length-1][1]]);
        const c2=findPrimeInRow(r2);
        path.push([r2, c2]);
      }
      path.forEach(([ri,ci],k)=>{ if(k%2===0) star[ri][ci]=true; else star[ri][ci]=false; });
      for(let i=0;i<n;i++) for(let j=0;j<n;j++) prime[i][j]=false;
      coverRow.fill(false); coverCol.fill(false);
    }
  }

  const res=Array(n).fill(-1);
  for(let i=0;i<n;i++) for(let j=0;j<n;j++) if(star[i][j]) res[i]=j;
  return res;
}

/** Email & intent helpers */
function _ensurePostFormUrl(){
  const ss=SpreadsheetApp.getActive(), sh=ss.getSheetByName('QR Codes'); if(!sh) return null;
  const v=sh.getDataRange().getValues();
  for (let i=1;i<v.length;i++){ if (v[i][0]==='Post-Event Form') return v[i][1]; }
  return null;
}
function _loadIntakeMap(){
  const ss = SpreadsheetApp.getActive();
  const sh = ss.getSheetByName('Intake Responses');
  const map = {};
  if (!sh) return map;
  const v = sh.getDataRange().getDisplayValues(); const h=v.shift();
  const cEmail = h.indexOf('Email Address'); const cGender=h.indexOf('Gender'); const cPrefG=h.indexOf('Preferred Gender(s)');
  v.forEach(r=>{ const e=_normEmail(r[cEmail]); if(!e) return; map[e]={gender:(r[cGender]||'').trim(), prefGenders:cPrefG>-1?(r[cPrefG]||'').trim():''}; });
  return map;
}
function _likesGraphFromPostSheet(sh){
  const v = sh.getDataRange().getDisplayValues(); const h=v.shift();
  const cEmail=h.indexOf('Email Address'); const likedCol=h.findIndex(x=>/^Enter emails of people you liked/i.test(x));
  const g={}; v.forEach(r=>{ const me=_normEmail(r[cEmail]); if(!me) return; const emails=String(r[likedCol]||'').toLowerCase().split(',').map(x=>_normEmail(x)).filter(Boolean); g[me]=new Set(emails.filter(e=>e!==me)); });
  return g;
}
function _computeMatches(graph, intakeMap){
  const pairsSet=new Set(), mutualPairs=[], oneWay=[];
  Object.keys(graph).forEach(a=>{
    graph[a].forEach(b=>{
      const both = graph[b] && graph[b].has(a);
      if (!both){ oneWay.push({from:a,to:b}); return; }
      const key=[a,b].sort().join('|'); if (pairsSet.has(key)) return;
      if (!CONFIG.post.sameGender){
        const ga=(intakeMap[a]?.gender||'').toLowerCase(), gb=(intakeMap[b]?.gender||'').toLowerCase();
        if (ga && gb && ga===gb) return;
      }
      pairsSet.add(key); mutualPairs.push([a,b]);
    });
  });
  return {mutualPairs, oneWay};
}
function _likesGraphFromIntent(sh){
  const v = sh.getDataRange().getDisplayValues();
  const h = v.shift();
  const cEmail = h.indexOf('Email Address');
  const pickCol = h.findIndex(t=>/Select up to/i.test(t));
  const g = {};
  v.forEach(r=>{
    const me = _normEmail(r[cEmail]); if(!me) return;
    const picks = String(r[pickCol]||'').split(',').map(x=>_normEmail(x.replace(/.*<|>.*/g,''))).filter(Boolean);
    g[me] = new Set(picks.filter(e=>e!==me));
  });
  return g;
}
function _emailTplMutual(me, partner, title){
  const safe = partner.replace(/</g,'&lt;').replace(/>/g,'&gt;');
  return '<p>You have a <strong>mutual match</strong> from <em>'+title+'</em>!</p><p>Here’s their email so you can connect: <a href="mailto:'+safe+'">'+safe+'</a></p><p>Good luck and have fun!</p>';
}
function _emailTplOneWay(recipient, liker, title){
  const safe = liker.replace(/</g,'&lt;').replace(/>/g,'&gt;');
  return '<p>Someone wanted to match with you after <em>'+title+'</em>.</p><p>If you’re interested, you can reach out: <a href="mailto:'+safe+'">'+safe+'</a></p>';
}
`;
}

/* ----- Wire buttons ----- */
el('gen').addEventListener('click', ()=>{ el('out').value = genGAS(); });
el('copy').addEventListener('click', async ()=>{ const t=el('out').value; if(!t) return; await navigator.clipboard.writeText(t); alert('Copied!'); });
el('dl').addEventListener('click', ()=>{ const t=el('out').value; if(!t) return; const blob=new Blob([t],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='SpeedDatingToolkit.gs'; document.body.appendChild(a); a.click(); a.remove(); });
el('clear').addEventListener('click', ()=>{ el('out').value=''; });
</script>
</body>
</html>
