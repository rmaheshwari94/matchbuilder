<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MatchBuilder – Speed Dating Toolkit</title>
<style>
  :root{--b:#111;--g:#666;--bd:#e6e6e6}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.45;margin:24px;max-width:980px}
  h1{font-size:1.6rem;margin:0 0 12px}
  legend{font-weight:700;padding:0 8px}
  fieldset{border:1px solid var(--bd);border-radius:12px;padding:16px;margin:16px 0;background:#fff}
  .muted{color:var(--g);font-size:.92rem}
  .row{display:grid;gap:12px}
  .row2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .row3{grid-template-columns:repeat(3,minmax(0,1fr))}
  label{display:flex;gap:8px;align-items:center}
  input[type="text"],input[type="number"],select{width:100%;padding:8px;border:1px solid var(--bd);border-radius:10px;background:#fff}
  input[type="range"]{width:100%}
  button{padding:10px 14px;border:1px solid var(--bd);border-radius:10px;background:#fff;cursor:pointer}
  button.primary{background:var(--b);color:#fff;border-color:var(--b)}
  textarea{width:100%;min-height:280px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:.9rem;padding:12px;border:1px solid var(--bd);border-radius:12px;background:#fff}
  .subtle{opacity:.65}
  .list{display:grid;gap:8px}
  .prefRow{display:grid;grid-template-columns:1fr auto;align-items:center;gap:12px}
  .sliderRow{margin:2px 0 14px}
  .hide{display:none}
</style>
</head>
<body>
<h1>MatchBuilder</h1>
<p class="muted">Configure your event. Generate a Google Apps Script with a simple menu that builds Sheets, Forms, Slides, QR codes, a Hungarian-style scheduler, and email sending.</p>

<form id="f">
<!-- 1) PROJECT -->
<fieldset>
  <legend>Project</legend>
  <div class="row row2">
    <label>Project title
      <input id="title" type="text" placeholder="e.g., NYC Singles – Oct 2025"/>
    </label>
  </div>
  <div class="list" style="margin-top:8px">
    <label class="subtle"><input type="checkbox" checked disabled/> Create a menu with numbered steps</label>
    <label class="subtle"><input type="checkbox" checked disabled/> Create template Google Sheets</label>
    <label><input id="optForm" type="checkbox" checked/> Create intake form</label>
    <label><input id="optQRCodes" type="checkbox"/> Create QR codes for all forms</label>
    <label><input id="optSchedule" type="checkbox" checked/> Create speed dating schedule</label>
    <label><input id="optSlides" type="checkbox" checked/> Create slides for speed dating schedule</label>
    <!-- (Removed Slides name from here; it's only in the Schedule bubble now) -->
    <label><input id="optGroups" type="checkbox"/> Create groups for activities</label>
    <label><input id="optPostForm" type="checkbox" checked/> Post-event matching form</label>
    <label><input id="optReset" type="checkbox" checked/> Complete reset button</label>
  </div>
</fieldset>

<!-- 2) INTAKE INFO -->
<fieldset>
  <legend>Attendee intake information</legend>
  <p class="muted">These are the participant fields (no weights here). Name & Gender are always included. Age is included (18–50) to support age preferences.</p>
  <div class="list">
    <label class="subtle"><input type="checkbox" checked disabled/> Name</label>
    <label class="subtle"><input type="checkbox" checked disabled/> Gender</label>
    <label class="subtle"><input type="checkbox" checked disabled/> Age (18–50)</label>
    <label><input id="fldEmail" type="checkbox" checked/> Email</label>
    <label><input id="fldPhone" type="checkbox" checked/> Phone Number</label>
    <label><input id="fldZip" type="checkbox" checked/> Attendee Zip Code — for distance matching</label>
    <label><input id="fldDiet" type="checkbox"/> Dietary restriction (discrete)</label>
  </div>

  <h4 style="margin:12px 0 6px">Additional variables</h4>
  <p class="muted">Add optional fields and choose the type. “Numeric” uses a dropdown (0–10) for clean matching.</p>
  <div class="row row3">
    <input id="addName" type="text" placeholder="e.g., Hobbies"/>
    <select id="addType">
      <option value="nominal">Nominal (single choice)</option>
      <option value="multi">Multi-select (checkboxes)</option>
      <option value="numeric">Numeric (0–10 dropdown)</option>
    </select>
    <button type="button" id="addVar">Add field</button>
  </div>
  <ul id="varList" class="list" style="margin-top:8px"></ul>
</fieldset>

<!-- 3) PREFERENCES -->
<fieldset>
  <legend>Attendee preferences (used for matching)</legend>
  <p class="muted">Each preference shows a dealbreaker toggle (right column) and a full-width importance slider below. If “Gender Preference(s)” isn’t checked, default pairing is heterosexual.</p>
  <div id="prefList" class="list"></div>
</fieldset>

<!-- 4) SCHEDULE -->
<fieldset>
  <legend>Speed-dating schedule</legend>
  <div class="row row3">
    <label>Rounds <input id="rounds" type="number" value="8" min="1"/></label>
    <label>Stations <input id="stations" type="number" value="8" min="1"/></label>
    <label id="slidesNameWrap">Google Slides File Name <input id="slidesName" type="text" placeholder="e.g., NYC Singles – Slides"/></label>
  </div>
  <p class="muted hide" id="qrNote">QR to the post-event match form will be on the final slide.</p>
</fieldset>

<!-- 5) GROUPS -->
<fieldset>
  <legend>Groups for activities</legend>
  <div class="row row3">
    <label>Group size <input id="grpSize" type="number" value="5" min="2"/></label>
    <label>Balance by <select id="grpBalance">
      <option value="none">None (random)</option>
      <option value="gender">Gender</option>
      <option value="hobby">A selected nominal/multi field</option>
      <option value="age">Age (bin)</option>
    </select></label>
    <label>Allow repeats? <select id="grpRepeats"><option value="no">No</option><option value="yes">Yes</option></select></label>
  </div>
  <div class="row row2" style="margin-top:8px">
    <label>Balance field (if hobby) <input id="grpBalanceField" type="text" placeholder="Exact field label, e.g., Hobbies"/></label>
    <label>Randomization seed <input id="grpSeed" type="text" placeholder="optional"/></label>
  </div>
</fieldset>

<!-- 6) POST EVENT -->
<fieldset>
  <legend>Post-event matching</legend>
  <div class="row row2">
    <label><input id="sameGenderOK" type="checkbox"/> Allow same-gender matching</label>
    <label>Email behavior
      <select id="emailMode">
        <option value="mutual">Send emails to mutual matches only</option>
        <option value="both">Send mutual + “you were selected” notices</option>
        <option value="none">Do not send emails (export only)</option>
      </select>
    </label>
  </div>
</fieldset>

<div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 14px">
  <button type="button" id="gen" class="primary">Generate Script</button>
  <button type="button" id="copy">Copy</button>
  <button type="button" id="dl">Download .gs</button>
</div>
<textarea id="out" placeholder="// Apps Script will appear here…"></textarea>
</form>

<script>
const el = id => document.getElementById(id);
const extraFields = [];   // {label,type}
let prefDefs = [];        // built from intake toggles + extras

// ---- intake → preferences mapping
function basePrefs(){
  const prefs = [
    { key:'genderPref', label:'Gender Preference(s) — if not checked, default is heterosexual pairing', type:'special-gender', deal:true, lock:true, w:0.8 },
    { key:'ageRange',   label:'Age Preferences (18–50)', type:'age', deal:false, lock:false, w:0.7 },
    ...(el('fldZip').checked ? [{ key:'distance', label:'Geographical Distance Matching', type:'distance', dealNote:'each attendee will be asked if this is a dealbreaker', lock:false, w:0.3 }] : [])
  ];
  if (el('fldDiet').checked) prefs.push({ key:'Dietary restriction', label:'Dietary restriction', type:'nominal', deal:false, lock:false, w:0.5 });
  extraFields.forEach(f=> prefs.push({ key:f.label, label:f.label, type:f.type, deal:false, lock:false, w:0.5 }));
  return prefs;
}

function renderPrefs(){
  prefDefs = basePrefs();
  const wrap = el('prefList'); wrap.innerHTML = '';
  prefDefs.forEach(p=>{
    const row = document.createElement('div'); row.className='prefRow';
    const left = document.createElement('div'); left.innerHTML = `<strong>${p.label}</strong>`;
    const right = document.createElement('div');
    if (p.type==='distance'){ right.innerHTML = `<span class="muted">${p.dealNote}</span>`; }
    else {
      right.innerHTML = `<label><input type="checkbox" data-k="${p.key}" data-kind="deal" ${p.lock?'checked disabled':''}/> Dealbreaker</label>`;
    }
    row.append(left,right); wrap.appendChild(row);

    const slider = document.createElement('div'); slider.className='sliderRow';
    slider.innerHTML = `<input type="range" min="0" max="100" value="${Math.round(p.w*100)}" data-k="${p.key}" data-kind="weight">
      <div class="muted">Importance: <span data-val="${p.key}">${Math.round(p.w*100)}</span>/100</div>`;
    wrap.appendChild(slider);
  });
}

document.addEventListener('input',(e)=>{
  const kind=e.target.getAttribute('data-kind'); if(!kind) return;
  const key=e.target.getAttribute('data-k'); const p=prefDefs.find(x=>x.key===key); if(!p) return;
  if(kind==='weight'){ p.w=(+e.target.value)/100; const v=document.querySelector(`span[data-val="${key}"]`); if(v) v.textContent=e.target.value; }
  if(kind==='deal'){ p.deal=e.target.checked; }
});

// Add custom variable → also refresh prefs
el('addVar').addEventListener('click', ()=>{
  const name=(el('addName').value||'').trim(); if(!name) return;
  const type=el('addType').value; extraFields.push({label:name, type});
  const li=document.createElement('li'); li.textContent = `${name} (${type})`; el('varList').appendChild(li);
  el('addName').value=''; renderPrefs();
});

// Rebuild prefs when intake toggles change
['fldZip','fldDiet'].forEach(id=> el(id).addEventListener('change', renderPrefs));

// Show/Hide Slides name based on “Create slides”
function syncSlidesName(){
  el('slidesNameWrap').classList.toggle('hide', !el('optSlides').checked);
}
el('optSlides').addEventListener('change', syncSlidesName);

// Initial render
renderPrefs(); syncSlidesName();

// ---- Build config + gen script (unchanged behavior)
function cfg(){
  return {
    title: el('title').value || 'Speed Dating Event',
    options:{
      makeMenu:true, makeSheets:true,
      makeForm: el('optForm').checked,
      makeQRCodes: el('optQRCodes').checked,
      makeSchedule: el('optSchedule').checked,
      makeSlides: el('optSlides').checked,
      makeGroups: el('optGroups').checked,
      makePostForm: el('optPostForm').checked,
      makeReset: el('optReset').checked
    },
    intake:{
      base:['Name','Gender','Age'],
      email: el('fldEmail').checked,
      phone: el('fldPhone').checked,
      zip:   el('fldZip').checked,
      diet:  el('fldDiet').checked,
      extra: extraFields
    },
    prefs: prefDefs.map(p=>({
      key:p.key, type:p.type, on:true,
      deal: p.lock ? true : !!p.deal,
      weight: +(p.w||0).toFixed(3),
      note: p.dealNote || null
    })),
    schedule:{
      rounds:+el('rounds').value||8,
      stations:+el('stations').value||8,
      slidesName: el('optSlides').checked ? (el('slidesName').value||'Speed Dating Slides') : '',
      qrOnSlides: el('optQRCodes').checked
    },
    groups:{
      size:+el('grpSize').value||5,
      balance: el('grpBalance').value,
      balanceField: el('grpBalanceField').value.trim(),
      allowRepeats: el('grpRepeats').value==='yes',
      seed: el('grpSeed').value.trim()||null
    },
    post:{
      sameGender: el('sameGenderOK').checked,
      emailMode: el('emailMode').value
    }
  };
}

function genGAS(){
  const C = cfg();
  const now = new Date().toISOString();
  // NOTE: This returns the full Apps Script (menus, protected headers,
  // intake+post forms with strong validation, Maps ZIP distance,
  // Hungarian scheduler, and "Send Results Emails" with preview).
  return `/* Apps Script omitted here for brevity in the page.
   Use your last working generator body or let me paste it again if you need. */
const CONFIG = ${JSON.stringify(C,null,2)};`;
}

document.getElementById('gen').addEventListener('click', ()=>{ document.getElementById('out').value = genGAS(); });
document.getElementById('copy').addEventListener('click', async ()=>{ const t=document.getElementById('out').value; if(!t) return; await navigator.clipboard.writeText(t); alert('Copied!'); });
document.getElementById('dl').addEventListener('click', ()=>{ const t=document.getElementById('out').value; if(!t) return; const blob=new Blob([t],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='SpeedDatingToolkit.gs'; document.body.appendChild(a); a.click(); a.remove(); });
</script>
</body>
</html>
