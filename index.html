<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MatchBuilder – Speed Dating Toolkit</title>
<style>
  :root{--b:#111;--g:#666;--bd:#e6e6e6}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.45;margin:24px;max-width:980px}
  h1{font-size:1.6rem;margin:0 0 12px}
  legend{font-weight:700;padding:0 8px}
  fieldset{border:1px solid var(--bd);border-radius:12px;padding:16px;margin:16px 0;background:#fff}
  .muted{color:var(--g);font-size:.92rem}
  .row{display:grid;gap:12px}
  .row2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .row3{grid-template-columns:repeat(3,minmax(0,1fr))}
  label{display:flex;gap:8px;align-items:center}
  input[type="text"],input[type="number"],select{width:100%;padding:8px;border:1px solid var(--bd);border-radius:10px;background:#fff}
  input[type="range"]{width:100%}
  button{padding:10px 14px;border:1px solid var(--bd);border-radius:10px;background:#fff;cursor:pointer}
  button.primary{background:var(--b);color:#fff;border-color:var(--b)}
  textarea{width:100%;min-height:280px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:.9rem;padding:12px;border:1px solid var(--bd);border-radius:12px;background:#fff}
  .subtle{opacity:.65}
  .list{display:grid;gap:8px}
  .prefRow{display:grid;grid-template-columns:1fr auto;align-items:center;gap:12px}
  .sliderRow{margin:2px 0 14px}
  .hide{display:none}
</style>
</head>
<body>
<h1>MatchBuilder</h1>
<p class="muted">Configure your event. Generate a Google Apps Script with a simple menu that builds Sheets, Forms, Slides, QR codes, a Hungarian-style scheduler, and email sending.</p>

<form id="f">
<!-- 1) PROJECT -->
<fieldset>
  <legend>Project</legend>
  <div class="row row2">
    <label>Project title
      <input id="title" type="text" placeholder="e.g., NYC Singles – Oct 2025"/>
    </label>
  </div>
  <div class="list" style="margin-top:8px">
    <label class="subtle"><input type="checkbox" checked disabled/> Create a menu with numbered steps</label>
    <label class="subtle"><input type="checkbox" checked disabled/> Create template Google Sheets</label>
    <label><input id="optForm" type="checkbox" checked/> Create intake form</label>
    <label><input id="optQRCodes" type="checkbox"/> Create QR codes for all forms</label>
    <label><input id="optSchedule" type="checkbox" checked/> Create speed dating schedule</label>
    <label><input id="optSlides" type="checkbox" checked/> Create slides for speed dating schedule</label>
    <div class="row row2">
      <label>Google Slides File Name
        <input id="slidesName" type="text" placeholder="e.g., NYC Singles – Slides"/>
      </label>
      <div class="muted" id="slidesHint">Shown only if Slides are enabled.</div>
    </div>
    <label><input id="optGroups" type="checkbox"/> Create groups for activities</label>
    <label><input id="optPostForm" type="checkbox" checked/> Post-event matching form</label>
    <label><input id="optReset" type="checkbox" checked/> Complete reset button</label>
  </div>
</fieldset>

<!-- 2) INTAKE INFO -->
<fieldset>
  <legend>Attendee intake information</legend>
  <p class="muted">These are the participant fields (no weights here). Name & Gender are always included. Age is included (18–50) to support age preferences.</p>
  <div class="list">
    <label class="subtle"><input type="checkbox" checked disabled/> Name</label>
    <label class="subtle"><input type="checkbox" checked disabled/> Gender</label>
    <label class="subtle"><input type="checkbox" checked disabled/> Age (18–50)</label>
    <label><input id="fldEmail" type="checkbox" checked/> Email</label>
    <label><input id="fldPhone" type="checkbox" checked/> Phone Number</label>
    <label><input id="fldZip" type="checkbox" checked/> Attendee Zip Code — for distance matching</label>
    <label><input id="fldDiet" type="checkbox"/> Dietary restriction (discrete)</label>
  </div>

  <h4 style="margin:12px 0 6px">Additional variables</h4>
  <p class="muted">Add optional fields and choose the type. “Numeric” uses a dropdown (0–10) for clean matching.</p>
  <div class="row row3">
    <input id="addName" type="text" placeholder="e.g., Hobbies"/>
    <select id="addType">
      <option value="nominal">Nominal (single choice)</option>
      <option value="multi">Multi-select (checkboxes)</option>
      <option value="numeric">Numeric (0–10 dropdown)</option>
    </select>
    <button type="button" id="addVar">Add field</button>
  </div>
  <ul id="varList" class="list" style="margin-top:8px"></ul>
</fieldset>

<!-- 3) PREFERENCES -->
<fieldset>
  <legend>Attendee preferences (used for matching)</legend>
  <p class="muted">Each preference has a dealbreaker checkbox and an importance slider. If the “Gender Preference(s)” box below is not checked, default pairing is heterosexual.</p>

  <div id="prefList" class="list"></div>
</fieldset>

<!-- 4) SCHEDULE -->
<fieldset>
  <legend>Speed-dating schedule</legend>
  <div class="row row3">
    <label>Rounds <input id="rounds" type="number" value="8" min="1"/></label>
    <label>Stations <input id="stations" type="number" value="8" min="1"/></label>
    <label class="" id="slidesNameWrap">Google Slides File Name <input id="slidesName2" type="text" placeholder="e.g., NYC Singles – Slides"/></label>
  </div>
  <p class="muted hide" id="qrNote">QR to the post-event match form will be on the final slide.</p>
</fieldset>

<!-- 5) GROUPS -->
<fieldset>
  <legend>Groups for activities</legend>
  <div class="row row3">
    <label>Group size <input id="grpSize" type="number" value="5" min="2"/></label>
    <label>Balance by <select id="grpBalance">
      <option value="none">None (random)</option>
      <option value="gender">Gender</option>
      <option value="hobby">A selected nominal/multi field</option>
      <option value="age">Age (bin)</option>
    </select></label>
    <label>Allow repeats? <select id="grpRepeats"><option value="no">No</option><option value="yes">Yes</option></select></label>
  </div>
  <div class="row row2" style="margin-top:8px">
    <label>Balance field (if hobby) <input id="grpBalanceField" type="text" placeholder="Exact field label, e.g., Hobbies"/></label>
    <label>Randomization seed <input id="grpSeed" type="text" placeholder="optional"/></label>
  </div>
</fieldset>

<!-- 6) POST EVENT -->
<fieldset>
  <legend>Post-event matching</legend>
  <div class="row row2">
    <label><input id="sameGenderOK" type="checkbox"/> Allow same-gender matching</label>
    <label>Email behavior
      <select id="emailMode">
        <option value="mutual">Send emails to mutual matches only</option>
        <option value="both">Send mutual + “you were selected” notices</option>
        <option value="none">Do not send emails (export only)</option>
      </select>
    </label>
  </div>
</fieldset>

<div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 14px">
  <button type="button" id="gen" class="primary">Generate Script</button>
  <button type="button" id="copy">Copy</button>
  <button type="button" id="dl">Download .gs</button>
</div>
<textarea id="out" placeholder="// Apps Script will appear here…"></textarea>
</form>

<script>
const el = id => document.getElementById(id);
const extraFields = []; // {label,type}
let prefDefs = [];      // dynamic preferences with dealbreaker + weight

// ---------- UI wiring ----------
function addVar(label, type){
  if(!label) return;
  extraFields.push({label, type});
  const li = document.createElement('li');
  li.textContent = `${label} (${type})`;
  el('varList').appendChild(li);
  rebuildPreferences();
}

function basePrefsFromToggles(){
  // Always include these core prefs
  const prefs = [
    { key:'genderPref', label:'Gender Preference(s) — if not checked, default is heterosexual pairing', type:'special-gender', hasDeal:true, dealLocked:true, on:true, weight:0.8 },
    { key:'ageRange', label:'Age Preferences (18–50)', type:'age', hasDeal:true, dealLocked:false, on:true, weight:0.7 },
    { key:'distance', label:'Geographical Distance Matching', type:'distance', hasDeal:false, dealLocked:false, on:el('fldZip').checked, weight:0.3, note:'each attendee will be asked if this is a dealbreaker' }
  ];
  // Intake toggles -> prefs
  if (el('fldDiet').checked) prefs.push({ key:'Dietary restriction', label:'Dietary restriction', type:'nominal', hasDeal:true, dealLocked:false, on:true, weight:0.5 });
  // Custom fields -> prefs
  extraFields.forEach(f=>{
    prefs.push({ key:f.label, label:f.label, type:f.type, hasDeal:true, dealLocked:false, on:true, weight:0.5 });
  });
  return prefs;
}

function rebuildPreferences(){
  prefDefs = basePrefsFromToggles();
  const wrap = el('prefList'); wrap.innerHTML = '';
  prefDefs.forEach(p=>{
    // Row with label (left) and dealbreaker (right or note)
    const row = document.createElement('div');
    row.className = 'prefRow';
    const left = document.createElement('div');
    left.innerHTML = `<strong>${p.label}</strong>`;
    const right = document.createElement('div');
    if (p.type==='distance'){
      right.innerHTML = `<span class="muted">${p.note}</span>`;
    } else if (p.hasDeal){
      const dis = p.dealLocked ? 'disabled' : '';
      const chk = p.dealLocked ? 'checked' : '';
      right.innerHTML = `<label><input type="checkbox" data-k="${p.key}" data-kind="deal" ${chk} ${dis}/> Dealbreaker</label>`;
    }
    row.append(left,right);
    wrap.appendChild(row);

    // Slider row full width
    const srow = document.createElement('div');
    srow.className = 'sliderRow';
    srow.innerHTML = `<input type="range" min="0" max="100" value="${Math.round((p.weight||0)*100)}" data-k="${p.key}" data-kind="weight">
      <div class="muted">Importance: <span data-val="${p.key}">${Math.round((p.weight||0)*100)}</span>/100</div>`;
    wrap.appendChild(srow);
  });
}

document.addEventListener('input',(e)=>{
  const kind = e.target.getAttribute('data-kind'); if(!kind) return;
  const key = e.target.getAttribute('data-k');
  const p = prefDefs.find(x=>x.key===key); if(!p) return;
  if (kind==='weight'){ p.weight = (+e.target.value)/100; const v = document.querySelector(`span[data-val="${key}"]`); if(v) v.textContent = e.target.value; }
  if (kind==='deal'){ p.deal = e.target.checked; }
});

el('addVar').addEventListener('click', ()=>{ addVar(el('addName').value.trim(), el('addType').value); el('addName').value=''; });
['fldZip','fldDiet'].forEach(id=> el(id).addEventListener('change', rebuildPreferences));

// Slides name show/hide
function toggleSlidesFields(){
  const on = el('optSlides').checked;
  el('slidesNameWrap').classList.toggle('hide', !on);
  el('slidesHint').classList.toggle('hide', on);
}
el('optSlides').addEventListener('change', toggleSlidesFields);
el('optQRCodes').addEventListener('change', ()=> el('qrNote').classList.toggle('hide', !el('optQRCodes').checked));
toggleSlidesFields();

// Initial preferences
rebuildPreferences();

// ---------- Build config ----------
function cfg(){
  return {
    title: el('title').value || 'Speed Dating Event',
    options:{
      makeMenu:true, makeSheets:true,
      makeForm: el('optForm').checked,
      makeQRCodes: el('optQRCodes').checked,
      makeSchedule: el('optSchedule').checked,
      makeSlides: el('optSlides').checked,
      makeGroups: el('optGroups').checked,
      makePostForm: el('optPostForm').checked,
      makeReset: el('optReset').checked
    },
    intake:{
      base:['Name','Gender','Age'],
      email: el('fldEmail').checked,
      phone: el('fldPhone').checked,
      zip:   el('fldZip').checked,
      diet:  el('fldDiet').checked,
      extra: extraFields // [{label,type}]
    },
    prefs: prefDefs.map(p=>({
      key:p.key, type:p.type, on:p.on!==false, deal:(p.dealLocked?true:!!p.deal), weight: +((p.weight||0).toFixed(3)),
      note: p.note || null
    })),
    schedule:{
      rounds: +el('rounds').value||8,
      stations: +el('stations').value||8,
      slidesName: (el('optSlides').checked ? (el('slidesName2').value||'Speed Dating Slides') : ''),
      qrOnSlides: el('optQRCodes').checked
    },
    groups:{
      size:+el('grpSize').value||5,
      balance: el('grpBalance').value,
      balanceField: el('grpBalanceField').value.trim(),
      allowRepeats: el('grpRepeats').value==='yes',
      seed: el('grpSeed').value.trim()||null
    },
    post:{
      sameGender: el('sameGenderOK').checked, // boolean
      emailMode: el('emailMode').value        // mutual | both | none
    }
  };
}

// ---------- Generate Apps Script ----------
function genGAS(){
  const C = cfg();
  const now = new Date().toISOString();
  return `/**
 * Generated by MatchBuilder
 * ${now}
 * Paste into a bound Apps Script (Extensions → Apps Script). Use the numbered menu.
 */
const CONFIG = ${JSON.stringify(C,null,2)};

/** MENU **/
function onOpen(){
  const ui = SpreadsheetApp.getUi();
  const m = ui.createMenu('Match Setup – Start Here');
  m.addItem('1) Set up your Sheets', 'step1_setupSheets');
  if (CONFIG.options.makeForm) m.addItem('2) Make the Sign-Up Form', 'step2_makeSignupForm');
  if (CONFIG.options.makeSchedule) m.addItem('3) Build the Speed-Dating Schedule', 'step3_buildSchedule');
  if (CONFIG.options.makeSlides) m.addItem('4) Create the Slideshow', 'step4_createSlides');
  if (CONFIG.options.makeGroups) m.addItem('5) Create Activity Groups', 'step5_createGroups');
  if (CONFIG.options.makePostForm) m.addItem('6) Make the Post-Event Match Form', 'step6_makePostForm');
  m.addItem('7) Send Results Emails', 'step7_sendResultsEmails');
  if (CONFIG.options.makeReset) m.addItem('Reset everything (danger)', 'stepX_resetEverything');
  m.addToUi();
}

/** ===== STEP 1: SHEETS + PROTECTED HEADERS ===== */
function step1_setupSheets(){
  const ss = SpreadsheetApp.getActive();
  const intake   = _sheet(ss,'Intake');
  const settings = _sheet(ss,'Settings');
  const pairs    = _sheet(ss,'Pairs');
  const schedule = _sheet(ss,'Schedule');
  const groups   = _sheet(ss,'Groups');
  const qr       = _sheet(ss,'QR Codes');

  const hdr = ['Timestamp','Name','Gender','Age'];
  if (CONFIG.intake.email) hdr.push('Email');
  if (CONFIG.intake.phone) hdr.push('Phone Number');
  if (CONFIG.intake.zip)   hdr.push('Zip');
  if (CONFIG.intake.diet)  hdr.push('Dietary restriction');
  CONFIG.intake.extra.forEach(f=>hdr.push(f.label));
  // preference responses (added by form)
  if (_prefOn('genderPref')) hdr.push('Preferred Gender(s)');
  if (_prefOn('ageRange'))   hdr.push('Preferred Minimum Age','Preferred Maximum Age','Age is a dealbreaker?');
  if (_prefOn('distance'))   hdr.push('OK meeting outside geographic area?','Is distance a dealbreaker?');
  CONFIG.prefs.filter(p=>!['genderPref','ageRange','distance'].includes(p.key)).forEach(p=>{
    if (p.type==='nominal') hdr.push(p.key + ' (preference)');
    else if (p.type==='multi') hdr.push(p.key + ' (preferred options)');
    else hdr.push(p.key + ' (preferred number)');
  });

  intake.clear(); intake.getRange(1,1,1,hdr.length).setValues([hdr]).setFontWeight('bold');
  intake.setFrozenRows(1); _protectHeader(intake,hdr.length);

  settings.clear();
  settings.getRange(1,1,1,2).setValues([['Key','Value']]).setFontWeight('bold');
  settings.getRange(2,1,6,2).setValues([
    ['Project Title', CONFIG.title],
    ['Rounds', CONFIG.schedule.rounds],
    ['Stations', CONFIG.schedule.stations],
    ['Slides Name', CONFIG.schedule.slidesName||''],
    ['Email Mode', CONFIG.post.emailMode],
    ['SameGender', CONFIG.post.sameGender ? 'Yes' : 'No'],
  ]);
  settings.setFrozenRows(1); _protectHeader(settings,2);

  pairs.clear();    pairs.getRange(1,1,1,4).setValues([['Round','Station','Person A','Person B']]).setFontWeight('bold'); pairs.setFrozenRows(1); _protectHeader(pairs,4);
  schedule.clear(); schedule.getRange(1,1,1,4).setValues([['Round','Station','Person A','Person B']]).setFontWeight('bold'); schedule.setFrozenRows(1); _protectHeader(schedule,4);
  groups.clear();   groups.getRange(1,1,1,3).setValues([['Group','Member','Notes']]).setFontWeight('bold'); groups.setFrozenRows(1); _protectHeader(groups,3);
  qr.clear();       qr.getRange(1,1,1,3).setValues([['Label','URL','QR Image']]).setFontWeight('bold'); qr.setFrozenRows(1); _protectHeader(qr,3);

  SpreadsheetApp.getUi().alert('Sheets are ready. Headers are protected.');
}

/** ===== STEP 2: SIGN-UP FORM (aggressive validation; dropdown ages; numeric as dropdown) ===== */
function step2_makeSignupForm(){
  const ss = SpreadsheetApp.getActive();
  const title = CONFIG.title + ' – Intake';
  const form = FormApp.create(title).setAllowResponseEdits(false);
  form.setCollectEmail(true);

  const name = form.addTextItem().setTitle('Name').setRequired(true);
  name.setValidation(FormApp.createTextValidation().requireTextLengthGreaterThan(1).build());

  form.addListItem().setTitle('Gender')
    .setChoiceValues(['Woman','Man','Nonbinary','Other']).setRequired(true);

  // Age (18–50) dropdown
  const ages = Array.from({length:33},(_,i)=>String(18+i)); // 18..50
  form.addListItem().setTitle('Age').setChoiceValues(ages).setRequired(true);

  if (CONFIG.intake.email){ /* collected automatically */ }
  if (CONFIG.intake.phone){
    const p = form.addTextItem().setTitle('Phone Number').setRequired(true);
    p.setValidation(FormApp.createTextValidation()
      .requireTextMatchesPattern('^(\\+1\\s?)?(\\(?\\d{3}\\)?[\\s.-]?)\\d{3}[\\s.-]?\\d{4}$')
      .setHelpText('Enter a valid US phone number')
      .build());
  }
  if (CONFIG.intake.zip){
    const z = form.addTextItem().setTitle('Zip').setRequired(true);
    z.setValidation(FormApp.createTextValidation()
      .requireTextMatchesPattern('^\\d{5}(-\\d{4})?$')
      .setHelpText('Enter 5 digits or 5-4 ZIP')
      .build());
  }
  if (CONFIG.intake.diet){
    form.addListItem().setTitle('Dietary restriction')
      .setChoiceValues(['None','Vegetarian','Vegan','Kosher','Halal','Other']).setRequired(true);
  }
  // Extra variables
  CONFIG.intake.extra.forEach(f=>{
    if (f.type==='nominal'){
      form.addListItem().setTitle(f.label).setChoiceValues(['Option 1','Option 2','Option 3']).setRequired(true);
    } else if (f.type==='multi'){
      const it = form.addCheckboxItem().setTitle(f.label).setChoiceValues(['Option A','Option B','Option C']).setRequired(true);
      it.setValidation(FormApp.createCheckboxValidation().requireSelectAtLeast(1).build());
    } else {
      form.addListItem().setTitle(f.label+' (number)').setChoiceValues(['0','1','2','3','4','5','6','7','8','9','10']).setRequired(true);
    }
  });

  // Preferences
  if (_prefOn('genderPref')){
    form.addCheckboxItem().setTitle('Preferred Gender(s)').setChoiceValues(['Woman','Man','Nonbinary']).setRequired(true);
  }
  if (_prefOn('ageRange')){
    const ages = Array.from({length:33},(_,i)=>String(18+i));
    form.addListItem().setTitle('Preferred Minimum Age (18–50)').setChoiceValues(ages).setRequired(true);
    form.addListItem().setTitle('Preferred Maximum Age (18–50)').setChoiceValues(ages).setRequired(true);
    form.addMultipleChoiceItem().setTitle('Age is a dealbreaker?').setChoiceValues(['Yes','No']).setRequired(true);
  }
  if (_prefOn('distance')){
    form.addMultipleChoiceItem().setTitle('OK meeting outside geographic area?').setChoiceValues(['Yes','No']).setRequired(true);
    form.addMultipleChoiceItem().setTitle('Is distance a dealbreaker?').setChoiceValues(['Yes','No']).setRequired(true);
  }
  // Extra fields mirrored into preferences
  CONFIG.prefs.filter(p=>!['genderPref','ageRange','distance'].includes(p.key)).forEach(p=>{
    if (p.type==='nominal'){
      form.addListItem().setTitle(p.key + ' (preference)').setChoiceValues(['Option 1','Option 2','Option 3']).setRequired(true);
    } else if (p.type==='multi'){
      const it = form.addCheckboxItem().setTitle(p.key + ' (preferred options)').setChoiceValues(['Option A','Option B','Option C']).setRequired(true);
      it.setValidation(FormApp.createCheckboxValidation().requireSelectAtLeast(1).build());
    } else {
      form.addListItem().setTitle(p.key + ' (preferred number)').setChoiceValues(['0','1','2','3','4','5','6','7','8','9','10']).setRequired(true);
    }
  });

  _writeQR('Intake Form', form.getEditUrl(), form.getPublishedUrl());
  const intakeResp = _linkFormToThisSpreadsheet(form, 'Intake Responses');
  SpreadsheetApp.getUi().alert('Sign-Up Form created and linked:\n' + form.getPublishedUrl() +
    (intakeResp ? '\nResponses → '+intakeResp.getName() : ''));
}

/** ===== STEP 3: SCHEDULER (Hungarian round-by-round) ===== */
function step3_buildSchedule(){
  const ss = SpreadsheetApp.getActive();
  const resp = ss.getSheetByName('Intake Responses');
  const sched = ss.getSheetByName('Schedule');
  if (!resp || !sched) throw new Error('Run Steps 1 and 2 first.');
  const data = _read(resp);
  const rows = _dedupeByEmail(data); // keep latest timestamp per Email Address

  // Partition by default hetero vs explicit gender prefs
  const defaultHetero = !_prefOn('genderPref');
  const A = [], B = [];
  rows.forEach(r=>{
    const g = (r['Gender']||'').toLowerCase();
    if (defaultHetero){
      if (g==='woman') A.push(r); else if (g==='man') B.push(r);
    } else {
      // If explicit gender prefs, we still bipartition to speed Hungarian; bucket by parity of index
      ((A.length<=B.length)?A:B).push(r);
    }
  });

  const rounds = CONFIG.schedule.rounds|0, stations = CONFIG.schedule.stations|0;
  const seen = new Set(); // prevent repeats "a|b"
  const out = [['Round','Station','Person A','Person B']];

  for (let r=1; r<=rounds; r++){
    const {pairs} = _maxWeightedMatchingRound(A,B,seen,rows, defaultHetero);
    // place into stations
    for (let s=1; s<=stations; s++){
      const p = pairs[s-1];
      if (!p) { out.push([r,s,'(idle)','(idle)']); continue; }
      out.push([r,s, _nameEmail(p.a), _nameEmail(p.b) ]);
      seen.add(_pairKey(p.a['Email Address'], p.b['Email Address']));
    }
  }

  sched.clear();
  sched.getRange(1,1,out.length,4).setValues(out).setFontWeight('bold');
  _protectHeader(sched,4);
  SpreadsheetApp.getUi().alert('Schedule generated.\nTip: adjust weights/dealbreakers in CONFIG if needed.');
}

/** ===== STEP 4: SLIDES ===== */
function step4_createSlides(){
  if (!CONFIG.options.makeSlides) { SpreadsheetApp.getUi().alert('Slides are disabled in Project.'); return; }
  const name = CONFIG.schedule.slidesName || 'Speed Dating Slides';
  const pres = SlidesApp.create(name);
  pres.getSlides()[0].getShapes()[0].getText().setText(CONFIG.title);
  if (CONFIG.options.makeQRCodes && CONFIG.options.makePostForm){
    const postUrl = _ensurePostFormUrl();
    const slide = pres.appendSlide(SlidesApp.PredefinedLayout.BLANK);
    slide.insertTextBox('Scan to submit your matches').setLeft(50).setTop(40);
    const blob = UrlFetchApp.fetch(_qr(postUrl, 400)).getBlob();
    slide.insertImage(blob).setLeft(50).setTop(100).setWidth(300);
  }
  SpreadsheetApp.getUi().alert('Slideshow created: ' + pres.getUrl());
}

/** ===== STEP 5: GROUPS (placeholder) ===== */
function step5_createGroups(){
  const ss = SpreadsheetApp.getActive(), groups = ss.getSheetByName('Groups');
  if (!groups) throw new Error('Run Step 1 first.');
  groups.clear();
  groups.getRange(1,1,1,3).setValues([['Group','Member','Notes']]).setFontWeight('bold'); _protectHeader(groups,3);
  for (let g=1; g<=Math.max(3, Math.floor(20/(CONFIG.groups.size||5))); g++){
    for (let i=1;i<=CONFIG.groups.size;i++){ groups.appendRow([g, '(TBD member)', '']); }
  }
}

/** ===== STEP 6: POST FORM ===== */
function step6_makePostForm(){
  const ss = SpreadsheetApp.getActive();
  const form = FormApp.create(CONFIG.title + ' – Post-Event Match');
  form.setCollectEmail(true);
  form.addSectionHeaderItem().setTitle('Who did you want to match with?');
  const p = form.addParagraphTextItem().setTitle('Enter emails of people you liked (comma-separated)').setRequired(true);
  p.setValidation(FormApp.createParagraphTextValidation()
    .requireTextMatchesPattern('^\\s*([A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}\\s*(,\\s*[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}\\s*)*)$')
    .setHelpText('Example: a@b.com, c@d.org').build());
  _writeQR('Post-Event Form', form.getEditUrl(), form.getPublishedUrl());
  const postResp = _linkFormToThisSpreadsheet(form, 'Post Match Responses');
  SpreadsheetApp.getUi().alert('Post-Event Form created and linked:\n' + form.getPublishedUrl() +
    (postResp ? '\nResponses → '+postResp.getName() : ''));
}

/** ===== STEP 7: EMAILS (preview/send) ===== */
function step7_sendResultsEmails(){
  const ui = SpreadsheetApp.getUi();
  const choice = ui.prompt('Send Results Emails',
    'Type PREVIEW to preview only, or SEND to actually email.', ui.ButtonSet.OK_CANCEL);
  if (choice.getSelectedButton() !== ui.Button.OK) return;
  const doSend = (choice.getResponseText()||'').trim().toUpperCase() === 'SEND';

  const ss = SpreadsheetApp.getActive();
  const post = ss.getSheetByName('Post Match Responses');
  if (!post) { ui.alert('Could not find "Post Match Responses". Run Step 6 first.'); return; }

  const intakeMap = _loadIntakeMap(); // email -> fields
  const graph = _likesGraphFromPostSheet(post); // email -> Set(emails liked)
  const { mutualPairs, oneWay } = _computeMatches(graph, intakeMap);

  const counts = `Mutual pairs: ${mutualPairs.length}\nOne-way likes: ${oneWay.length}`;
  if (!doSend) { ui.alert('PREVIEW MODE\n'+counts); return; }

  const title = CONFIG.title || 'Your Event';
  let sent = 0, skipped = 0;
  mutualPairs.forEach(([a,b])=>{
    const subj = `You matched! (${title})`;
    try { MailApp.sendEmail({to:a, subject:subj, htmlBody:_emailTplMutual(a,b,title), name:title}); sent++; } catch(e){ skipped++; }
    try { MailApp.sendEmail({to:b, subject:subj, htmlBody:_emailTplMutual(b,a,title), name:title}); sent++; } catch(e){ skipped++; }
  });
  if (CONFIG.post.emailMode === 'both'){
    oneWay.forEach(({from,to})=>{
      try { MailApp.sendEmail({to, subject:`Someone wanted to match with you (${title})`, htmlBody:_emailTplOneWay(to, from, title), name:title}); sent++; } catch(e){ skipped++; }
    });
  }
  ui.alert(`Done.\n${counts}\nEmails sent: ${sent}\nSkipped: ${skipped}`);
}

/** RESET */
function stepX_resetEverything(){
  const ss = SpreadsheetApp.getActive();
  ['Schedule','Pairs','Groups','QR Codes'].forEach(n=>{const sh=ss.getSheetByName(n); if(sh) sh.clear();});
  SpreadsheetApp.getUi().alert('Cleared generated sheets. (Forms/Slides remain.)');
}

/** ===== Helpers (headers, QR, forms, data) ===== */
function _sheet(ss,name){ return ss.getSheetByName(name)||ss.insertSheet(name); }
function _protectHeader(sh, cols){
  const r = sh.getRange(1,1,1,cols);
  const p = r.protect().setDescription(sh.getName()+' header');
  p.removeEditors(p.getEditors());
  p.addEditor(Session.getEffectiveUser());
}
function _qr(u, size){ return 'https://chart.googleapis.com/chart?chs='+size+'x'+size+'&cht=qr&chl='+encodeURIComponent(u); }
function _writeQR(label, editUrl, liveUrl){
  const ss = SpreadsheetApp.getActive(), sh = _sheet(ss,'QR Codes');
  const row = sh.getLastRow()+1;
  sh.getRange(row,1,1,2).setValues([[label, liveUrl]]);
  try{ if (CONFIG.options.makeQRCodes){ const blob=UrlFetchApp.fetch(_qr(liveUrl, 300)).getBlob(); sh.insertImage(blob,3,row);} }catch(e){}
}
function _linkFormToThisSpreadsheet(form, desiredName){
  const ss = SpreadsheetApp.getActive();
  const before = ss.getSheets().map(s=>s.getSheetId());
  form.setDestination(FormApp.DestinationType.SPREADSHEET, ss.getId());
  SpreadsheetApp.flush();
  const after = ss.getSheets();
  const added = after.find(s => before.indexOf(s.getSheetId()) === -1);
  if (added) { try{added.setName(desiredName);}catch(e){} return added; }
  return ss.getSheetByName(desiredName) || ss.getSheetByName('Form Responses 1');
}
function _read(sh){ const v=sh.getDataRange().getDisplayValues(); const h=v.shift(); return v.map(r=>{const o={}; h.forEach((c,i)=>o[c]=r[i]); return o;}); }
function _normEmail(x){ return String(x||'').trim().toLowerCase(); }
function _nameEmail(r){ const e=r['Email Address']||''; return r['Name'] ? r['Name']+' <'+e+'>' : e; }
function _pairKey(a,b){ const A=_normEmail(a),B=_normEmail(b); return [A,B].sort().join('|'); }
function _zip5(z){ const m=String(z||'').match(/\\d{5}/); return m?m[0]:''; }

function _dedupeByEmail(rows){
  // keep latest by Timestamp
  const idx={}; const out=[];
  rows.forEach(r=>{
    const em=_normEmail(r['Email Address']); if(!em) return;
    const t = new Date(r['Timestamp']).getTime()||0;
    if(!(em in idx)){ idx[em]=out.length; out.push(r); }
    else {
      const prev = out[idx[em]];
      const tp = new Date(prev['Timestamp']).getTime()||0;
      if (t>=tp) out[idx[em]] = r; // keep latest
    }
  });
  return out;
}

/** Maps / Distance */
function geocodeZip(zip){
  try{ const res = Maps.newGeocoder().geocode(zip); if(res.status==='OK' && res.results && res.results[0]){ const loc=res.results[0].geometry.location; return {lat:loc.lat, lng:loc.lng}; } }catch(e){}
  return null;
}
function distanceMilesFromZips(zipA, zipB){
  const a = geocodeZip(_zip5(zipA)), b = geocodeZip(_zip5(zipB));
  if(!a||!b) return null;
  return _hav(a.lat,a.lng,b.lat,b.lng);
}
function _hav(lat1,lon1,lat2,lon2){
  const R=3958.761; const toRad=x=>x*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const s = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(s));
}

/** Preferences on/off */
function _prefOn(key){ const p=CONFIG.prefs.find(x=>x.key===key); return !!(p && p.on!==false); }
function _pref(key){ return CONFIG.prefs.find(x=>x.key===key); }

/** Scoring (0..1) with dealbreakers */
function _score(a,b, defaultHetero){
  // Dealbreakers default false unless set; any fail -> 0
  // Gender default: heterosexual if genderPref is off
  const gA=(a['Gender']||'').toLowerCase(), gB=(b['Gender']||'').toLowerCase();

  // Gender logic
  if (!_prefOn('genderPref')){
    const hetero = (gA==='woman' && gB==='man') || (gA==='man' && gB==='woman');
    if (!hetero) return 0;
  } else {
    const pa=(a['Preferred Gender(s)']||'').toLowerCase(), pb=(b['Preferred Gender(s)']||'').toLowerCase();
    const aOk = pa.includes(gB); const bOk = pb.includes(gA);
    if (!aOk || !bOk) return 0; // mandatory dealbreaker for gender
  }

  let score = 0;

  // Age
  if (_prefOn('ageRange')){
    const p = _pref('ageRange');
    const aAge = +a['Age']||0, bAge=+b['Age']||0;
    const aMin=+a['Preferred Minimum Age']||18, aMax=+a['Preferred Maximum Age']||50;
    const bMin=+b['Preferred Minimum Age']||18, bMax=+b['Preferred Maximum Age']||50;
    const aPass = (bAge>=aMin && bAge<=aMax);
    const bPass = (aAge>=bMin && aAge<=bMax);
    if (p.deal && (!aPass || !bPass)) return 0;
    const w=p.weight||0; if (w>0){ const sub = (aPass?0.5:0) + (bPass?0.5:0); score += w*sub; }
  }

  // Distance
  if (_prefOn('distance')){
    const p=_pref('distance');
    const zA=a['Zip']||'', zB=b['Zip']||'';
    const miles = (zA && zB) ? distanceMilesFromZips(zA, zB) : null;
    const okOutsideA=(a['OK meeting outside geographic area?']||'No')==='Yes';
    const okOutsideB=(b['OK meeting outside geographic area?']||'No')==='Yes';
    const distDealA=(a['Is distance a dealbreaker?']||'No')==='Yes';
    const distDealB=(b['Is distance a dealbreaker?']||'No')==='Yes';
    const within = miles===null ? true : miles<=25; // default threshold
    if ((distDealA || distDealB) && !within) return 0;
    const w=p.weight||0; if (w>0){ score += w * (within ? 1 : (okOutsideA && okOutsideB ? 0.6 : 0.2)); }
  }

  // Diet
  if (_prefOn('Dietary restriction')){
    const p=_pref('Dietary restriction');
    const eq = (a['Dietary restriction']||'') === (b['Dietary restriction']||'');
    if (p.deal && !eq) return 0;
    const w=p.weight||0; if (w>0) score += w * (eq?1:0);
  }

  // Custom extras
  CONFIG.prefs.filter(p=>!['genderPref','ageRange','distance','Dietary restriction'].includes(p.key)).forEach(p=>{
    const w=p.weight||0; if (w<=0) return;
    if (p.type==='nominal'){
      const eq = (a[p.key]||'') === (b[p.key]||'');
      if (p.deal && !eq) { score = 0; return; }
      score += w*(eq?1:0);
    } else if (p.type==='multi'){
      const setA = new Set(String(a[p.key+' (preferred options)']||'').split(',').map(x=>x.trim()).filter(Boolean));
      const setB = new Set(String(b[p.key+' (preferred options)']||'').split(',').map(x=>x.trim()).filter(Boolean));
      const inter = [...setA].filter(x=>setB.has(x)).length;
      const union = new Set([...setA,...setB]).size || 1;
      const sim = inter/union;
      if (p.deal && sim===0) { score = 0; return; }
      score += w*sim;
    } else { // numeric dropdown 0..10 — closer is better
      const av = +(a[p.key+' (preferred number)']||0), bv = +(b[p.key+' (preferred number)']||0);
      const sim = 1 - Math.min(1, Math.abs(av-bv)/10);
      if (p.deal && sim<0.5) { score = 0; return; }
      score += w*sim;
    }
  });

  return score;
}

/** Round matching with Hungarian */
function _maxWeightedMatchingRound(A,B,seen,allRows, defaultHetero){
  const n = Math.max(A.length, B.length);
  const cost = Array.from({length:n},()=>Array(n).fill(1e6)); // we minimize cost, so use (1-score)
  const idxA=[], idxB=[];
  for(let i=0;i<n;i++){ idxA[i]=A[i]||null; idxB[i]=B[i]||null; }
  for(let i=0;i<n;i++){
    for(let j=0;j<n;j++){
      const a = idxA[i], b = idxB[j];
      if (!a || !b) { cost[i][j]=1e6; continue; }
      const k = _pairKey(a['Email Address'], b['Email Address']);
      if (seen.has(k)) { cost[i][j]=1e6; continue; }
      const s = _score(a,b, defaultHetero); // 0..1
      if (s<=0) { cost[i][j]=1e6; continue; }
      cost[i][j] = 1 - s;
    }
  }
  const assign = _hungarian(cost);
  const pairs = [];
  assign.forEach((j,i)=>{ if (j>=0 && idxA[i] && idxB[j] && cost[i][j]<1e6) pairs.push({a:idxA[i], b:idxB[j]}); });
  return {pairs};
}

/** Hungarian Algorithm (O(n^3)) for square matrix; -1 if row/col unmatched */
function _hungarian(matrix){
  const n = matrix.length; if (n===0) return [];
  const m = matrix.map(r=>r.slice());
  // pad NaNs
  for(let i=0;i<n;i++) for(let j=0;j<n;j++) if(!isFinite(m[i][j])) m[i][j]=1e6;
  // subtract row mins
  for(let i=0;i<n;i++){ let min=Math.min(...m[i]); for(let j=0;j<n;j++) m[i][j]-=min; }
  // subtract col mins
  for(let j=0;j<n;j++){ let min=1e9; for(let i=0;i<n;i++) min=Math.min(min,m[i][j]); for(let i=0;i<n;i++) m[i][j]-=min; }
  let coverRow = Array(n).fill(false), coverCol = Array(n).fill(false);
  let star = Array.from({length:n},()=>Array(n).fill(false));
  let prime = Array.from({length:n},()=>Array(n).fill(false));
  // star zeros greedily
  for(let i=0;i<n;i++) for(let j=0;j<n;j++) if(m[i][j]===0 && !coverRow[i] && !coverCol[j]){ star[i][j]=true; coverRow[i]=coverCol[j]=true; }
  coverRow.fill(false); coverCol.fill(false);

  function colOfStarInRow(r){ for(let j=0;j<n;j++) if(star[r][j]) return j; return -1; }
  function rowOfStarInCol(c){ for(let i=0;i<n;i++) if(star[i][c]) return i; return -1; }
  function rowOfPrimeInCol(c){ for(let i=0;i<n;i++) if(prime[i][c]) return i; return -1; }
  function findZero(){ for(let i=0;i<n;i++) if(!coverRow[i]) for(let j=0;j<n;j++) if(!coverCol[j] && m[i][j]===0) return [i,j]; return null; }
  function minUncovered(){ let min=1e9; for(let i=0;i<n;i++) if(!coverRow[i]) for(let j=0;j<n;j++) if(!coverCol[j]) min=Math.min(min,m[i][j]); return min; }

  while(true){
    // cover columns with starred zeros
    for(let i=0;i<n;i++) for(let j=0;j<n;j++) if(star[i][j]) coverCol[j]=true;
    let countCovered = coverCol.filter(Boolean).length;
    if (countCovered===n) break; // optimal
    while(true){
      const z = findZero();
      if (!z){
        const min = minUncovered();
        for(let i=0;i<n;i++) if(coverRow[i]) for(let j=0;j<n;j++) m[i][j]+=min;
        for(let j=0;j<n;j++) if(!coverCol[j]) for(let i=0;i<n;i++) m[i][j]-=min;
      } else {
        const [i,j]=z; prime[i][j]=true;
        const sj = colOfStarInRow(i);
        if (sj!==-1){ coverRow[i]=true; coverCol[sj]=false; }
        else {
          // augmenting path
          let path = [[i,j]];
          while(true){
            const r = rowOfStarInCol(path[path.length-1][1]);
            if (r===-1) break;
            path.push([r, path[path.length-1][1]]);
            const c = colOfPrimeInRow(r); // find prime in row r
            function colOfPrimeInRow(rr){ for(let jj=0;jj<n;jj++) if(prime[rr][jj]) return jj; return -1; }
            path.push([r, c]);
          }
          path.forEach(([r,c],k)=>{ if (k%2===0) star[r][c]=true; else star[r][c]=false; });
          prime = Array.from({length:n},()=>Array(n).fill(false));
          coverRow.fill(false); coverCol.fill(false);
          break;
        }
      }
    }
  }
  const result = Array(n).fill(-1);
  for(let i=0;i<n;i++) for(let j=0;j<n;j++) if(star[i][j]) result[i]=j;
  return result;
}

/** Email helpers */
function _loadIntakeMap(){
  const ss = SpreadsheetApp.getActive();
  const sh = ss.getSheetByName('Intake Responses');
  const map = {};
  if (!sh) return map;
  const v = sh.getDataRange().getDisplayValues(); const h=v.shift();
  const cEmail = h.indexOf('Email Address'); const cGender=h.indexOf('Gender'); const cPrefG=h.indexOf('Preferred Gender(s)');
  v.forEach(r=>{ const e=_normEmail(r[cEmail]); if(!e) return; map[e]={gender:(r[cGender]||'').trim(), prefGenders:cPrefG>-1?(r[cPrefG]||'').trim():''}; });
  return map;
}
function _likesGraphFromPostSheet(sh){
  const v = sh.getDataRange().getDisplayValues(); const h=v.shift();
  const cEmail=h.indexOf('Email Address'); const likedCol=h.findIndex(x=>/^Enter emails of people you liked/i.test(x));
  const g={}; v.forEach(r=>{ const me=_normEmail(r[cEmail]); if(!me) return; const emails=String(r[likedCol]||'').toLowerCase().split(',').map(x=>_normEmail(x)).filter(Boolean); g[me]=new Set(emails.filter(e=>e!==me)); });
  return g;
}
function _computeMatches(graph, intakeMap){
  const pairsSet=new Set(), mutualPairs=[], oneWay=[];
  Object.keys(graph).forEach(a=>{
    graph[a].forEach(b=>{
      const both = graph[b] && graph[b].has(a);
      if (!both){ oneWay.push({from:a,to:b}); return; }
      const key=[a,b].sort().join('|'); if (pairsSet.has(key)) return;
      // same-gender policy
      if (!CONFIG.post.sameGender){
        const ga=(intakeMap[a]?.gender||'').toLowerCase(), gb=(intakeMap[b]?.gender||'').toLowerCase();
        if (ga && gb && ga===gb) return;
      }
      pairsSet.add(key); mutualPairs.push([a,b]);
    });
  });
  return {mutualPairs, oneWay};
}
function _emailTplMutual(me, partner, title){
  const safe = partner.replace(/</g,'&lt;').replace(/>/g,'&gt;');
  return `<p>You have a <strong>mutual match</strong> from <em>${title}</em>!</p>
  <p>Here’s their email so you can connect: <a href="mailto:${safe}">${safe}</a></p>
  <p>Good luck and have fun!</p>`;
}
function _emailTplOneWay(recipient, liker, title){
  const safe = liker.replace(/</g,'&lt;').replace(/>/g,'&gt;');
  return `<p>Someone wanted to match with you after <em>${title}</em>.</p>
  <p>If you’re interested, you can reach out: <a href="mailto:${safe}">${safe}</a></p>`;
}
</script>
</body>
</html>
